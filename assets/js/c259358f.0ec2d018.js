"use strict";(self.webpackChunkreact_book=self.webpackChunkreact_book||[]).push([[9776],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>m});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function f(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?f(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):f(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},f=Object.keys(e);for(o=0;o<f.length;o++)n=f[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var f=Object.getOwnPropertySymbols(e);for(o=0;o<f.length;o++)n=f[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=o.createContext({}),u=function(e){var t=o.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},s=function(e){var t=u(e.components);return o.createElement(i.Provider,{value:t},e.children)},l="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,f=e.originalType,i=e.parentName,s=r(e,["components","mdxType","originalType","parentName"]),l=u(n),d=a,m=l["".concat(i,".").concat(d)]||l[d]||p[d]||f;return n?o.createElement(m,c(c({ref:t},s),{},{components:n})):o.createElement(m,c({ref:t},s))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var f=n.length,c=new Array(f);c[0]=d;var r={};for(var i in t)hasOwnProperty.call(t,i)&&(r[i]=t[i]);r.originalType=e,r[l]="string"==typeof e?e:a,c[1]=r;for(var u=2;u<f;u++)c[u]=n[u];return o.createElement.apply(null,c)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"},9580:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>c,default:()=>p,frontMatter:()=>f,metadata:()=>r,toc:()=>u});var o=n(7462),a=(n(7294),n(3905));const f={},c=void 0,r={unversionedId:"v16/hooks/useEffect-useLayoutEffect",id:"v16/hooks/useEffect-useLayoutEffect",title:"useEffect-useLayoutEffect",description:"\u672c\u7bc7\u4ecb\u7ecduseEffect\u548cuseLayoutEffect\uff1a",source:"@site/docs/v16/hooks/useEffect-useLayoutEffect.md",sourceDirName:"v16/hooks",slug:"/v16/hooks/useEffect-useLayoutEffect",permalink:"/react-book/docs/v16/hooks/useEffect-useLayoutEffect",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/v16/hooks/useEffect-useLayoutEffect.md",tags:[],version:"current",frontMatter:{},sidebar:"v16Sidebar",previous:{title:"hooks",permalink:"/react-book/docs/v16/hooks/hooks"},next:{title:"useState-useReducer",permalink:"/react-book/docs/v16/hooks/useState-useReducer"}},i={},u=[{value:"1.  \u57fa\u7840",id:"1--\u57fa\u7840",level:3},{value:"2. mount",id:"2-mount",level:3},{value:"3. update",id:"3-update",level:3},{value:"4. \u6267\u884c\u9636\u6bb5",id:"4-\u6267\u884c\u9636\u6bb5",level:3},{value:"4.1 \u5f02\u6b65\u6267\u884cuseEffect",id:"41-\u5f02\u6b65\u6267\u884cuseeffect",level:4},{value:"4.2 \u540c\u6b65\u6267\u884cuseLayoutEffect",id:"42-\u540c\u6b65\u6267\u884cuselayouteffect",level:4},{value:"5. \u793a\u4f8b",id:"5-\u793a\u4f8b",level:3}],s={toc:u},l="wrapper";function p(e){let{components:t,...n}=e;return(0,a.kt)(l,(0,o.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"\u672c\u7bc7\u4ecb\u7ecd",(0,a.kt)("inlineCode",{parentName:"p"},"useEffect"),"\u548c",(0,a.kt)("inlineCode",{parentName:"p"},"useLayoutEffect"),"\uff1a"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"[!INFO]","\n\u5982\u679c\u4f60\u719f\u6089 React class \u7684\u751f\u547d\u5468\u671f\u51fd\u6570\uff0c\u4f60\u53ef\u4ee5\u628a ",(0,a.kt)("inlineCode",{parentName:"p"},"useEffect")," Hook \u770b\u505a ",(0,a.kt)("inlineCode",{parentName:"p"},"componentDidMount"),"\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"componentDidUpdate")," \u548c ",(0,a.kt)("inlineCode",{parentName:"p"},"componentWillUnmount")," \u8fd9\u4e09\u4e2a\u51fd\u6570\u7684\u7ec4\u5408\u3002")),(0,a.kt)("h3",{id:"1--\u57fa\u7840"},"1.  \u57fa\u7840"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"useEffect"),"\u4e0e",(0,a.kt)("inlineCode",{parentName:"p"},"useLayoutEffect"),"\u4e24\u8005\u6700\u5927\u7684\u533a\u522b\u662f\u6267\u884c\u65f6\u673a\u7684\u95ee\u9898\uff1a",(0,a.kt)("inlineCode",{parentName:"p"},"useEffect"),"\u662f\u5f02\u6b65\u6267\u884c\uff0c\u901a\u8fc7",(0,a.kt)("inlineCode",{parentName:"p"},"react"),"\u7684\u8c03\u5ea6\u7b56\u7565\u5728\u7a7a\u95f2\u65f6\u673a\u6267\u884c\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"useLayoutEffect"),"\u662f\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"fiber"),"\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"commit"),"\u9636\u6bb5\u540c\u6b65\u6267\u884c\u3002\u8fd9\u4e5f\u5c31\u9020\u6210\u4e24\u8005\u8868\u73b0\u4e0a\u7684\u533a\u522b\uff1a"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"useLayoutEffect"),"\u76f8\u6bd4",(0,a.kt)("inlineCode",{parentName:"li"},"useEffect"),"\uff0c\u901a\u8fc7\u540c\u6b65\u6267\u884c\u72b6\u6001\u66f4\u65b0\u53ef\u89e3\u51b3\u5728\u4e00\u4e9b\u7279\u6b8a\u573a\u666f\u4e0b\u7684\u95ea\u70c1\u95ee\u9898\u3002"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"useEffect"),"\u53ef\u4ee5\u6ee1\u8db3\u767e\u5206\u4e4b99\u4ee5\u4e0a\u7684\u573a\u666f\uff0c\u800c\u4e14",(0,a.kt)("inlineCode",{parentName:"li"},"useLayoutEffect"),"\u662f\u540c\u6b65\u6267\u884c\uff0c\u4f1a\u963b\u585e\u6e32\u67d3\u3002")),(0,a.kt)("h3",{id:"2-mount"},"2. mount"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"useEffect"),"\u4e0e",(0,a.kt)("inlineCode",{parentName:"p"},"useLayoutEffect"),"\u6302\u8f7d\u9636\u6bb5\u5bf9\u6bd4\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"function mountEffect(create,deps) {\n  // \u6b64\u5904\u76f4\u63a5\u8c03\u7528mountEffectImpl,\u8bbe\u7f6e\u4e24\u4e2aeffectTag\n  return mountEffectImpl(\n    UpdateEffect | PassiveEffect,\n    // \u8fd9\u91cc\u4f20\u5165\u4e00\u4e2apassive\u7684\u6807\u5fd7\n    HookPassive,  \n    create,\n    deps,\n  );\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"function mountLayoutEffect(create,deps) {\n  return mountEffectImpl(\n    UpdateEffect,\n    // \u8fd9\u91cc\u4f20\u5165\u4e00\u4e2alayout\u7684\u6807\u5fd7\n    HookLayout, \n    create,\n    deps\n  );\n}\n")),(0,a.kt)("p",null,"\u6ce8\u610f\u8fd9\u91cc\u8c03\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"mountEffectImpl"),"\u65f6\u4f20\u5165\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"tag"),"\u4e0d\u540c\uff0c\u5176\u5b9e\u5728\u6700\u540e\u7684\u8c03\u7528\u9636\u6bb5\u5c31\u662f\u6839\u636e\u8fd9\u4e0d\u540c\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"tag"),"\u6765\u51b3\u5b9a\u662f\u540c\u6b65\u8c03\u7528\u8fd8\u662f\u5f02\u6b65\u8c03\u7528\u3002"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"mountEffectImpl"),"\u4e0e",(0,a.kt)("inlineCode",{parentName:"p"},"pushEffect"),"\u51fd\u6570\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"function mountEffectImpl(fiberEffectTag, hookEffectTag, create, deps): void {\n  // const hook: Hook = {\n  //   memoizedState: null,\n  //   baseState: null,\n  //   baseQueue: null,\n  //   queue: null,\n  //   next: null,\n  // };\n    // \u4e0emountState\u5185\u8c03\u7528\u540c\u4e00\u4e2a\u51fd\u6570\uff0c\u521b\u5efa\u4e00\u4e2ahook\u5bf9\u8c61\n  const hook = mountWorkInProgressHook();\n  const nextDeps = deps === undefined ? null : deps;\n  // \u7ed9\u5f53\u524dfiber\u52a0\u4e0afiberEffectTag\u6807\u5fd7\u4f4d\n  currentlyRenderingFiber.effectTag |= fiberEffectTag;\n    // \u6302\u8f7d\u5230fiber.memoizedState\u4e0a\uff0c\u4ee5next\u8fde\u63a5\u4e0b\u4e00\u4e2ahook\u5bf9\u8c61\u3002\n  // \u8fd9\u91ccmemoizedState\u6302\u8f7d\u7684\u662f\u53f3\u8fb9\u51fd\u6570\u7684effect\u5bf9\u8c61\n  hook.memoizedState = pushEffect(\n        // \u8fd9\u91cc\u7684\u6807\u5fd7\u4f4d\u518d\u52a0\u4e0a\u4e00\u4e2aHookHasEffect\u6807\u5fd7\u4f4d\n    HookHasEffect | hookEffectTag,\n    create,\n    undefined,\n    nextDeps,\n  );\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"function pushEffect(tag, create, destroy, deps) {\n  // return \u8fd9\u4e2aeffect,\u6302\u8f7d\u5230fiber.memoizedState\u4e0a\n  const effect: Effect = {\n    tag,\n    create,\n    destroy,\n    deps,\n    next: (null: any),\n  };\n\n  // \u5c06effect\u52a0\u8f7dfiber.updateQueue\u94fe\u8868\u91cc\n  let componentUpdateQueue: null | FunctionComponentUpdateQueue = (currentlyRenderingFiber.updateQueue: any);\n  if (componentUpdateQueue === null) {\n    // \u8fd4\u56de\u4e00\u4e2a\u53ea\u6709{ lastEffect: null }\u7684\u5bf9\u8c61\n    componentUpdateQueue = createFunctionComponentUpdateQueue();\n    currentlyRenderingFiber.updateQueue = (componentUpdateQueue: any);\n    componentUpdateQueue.lastEffect = effect.next = effect;\n  } else {\n    const lastEffect = componentUpdateQueue.lastEffect;\n    if (lastEffect === null) {\n      componentUpdateQueue.lastEffect = effect.next = effect;\n    } else {\n      const firstEffect = lastEffect.next;\n      lastEffect.next = effect;\n      effect.next = firstEffect;\n      componentUpdateQueue.lastEffect = effect;\n    }\n  }\n\n  return effect;\n}\n")),(0,a.kt)("h3",{id:"3-update"},"3. update"),(0,a.kt)("p",null,"\u9664\u6b64\u4e00\u6b21\u6267\u884c",(0,a.kt)("inlineCode",{parentName:"p"},"renderWithHooks"),"\u5916\uff0c\u5176\u4ed6\u9636\u6bb5\u90fd\u6267\u884c",(0,a.kt)("inlineCode",{parentName:"p"},"updateEffect"),"\u6216\u8005",(0,a.kt)("inlineCode",{parentName:"p"},"updateLayoutEffect"),"\u3002"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"useEffect"),"\u4e0e",(0,a.kt)("inlineCode",{parentName:"p"},"useLayoutEffect"),"\u66f4\u65b0\u9636\u6bb5\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"function updateEffect(create,deps) {\n  return updateEffectImpl(\n    UpdateEffect | PassiveEffect,\n    // \u6ce8\u610f\u8fd9\u91cc\u4f9d\u7136\u4f20\u5165\u7684\u662fPassive\u7684\u6807\u5fd7\u4f4d\n    HookPassive,\n    create,\n    deps,\n  );\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"function updateLayoutEffect(create, deps) {\n  return updateEffectImpl(\n    UpdateEffect,\n    // \u8fd9\u91cc\u4f20\u5165\u7684\u662fLayout\u6807\u5fd7\u4f4d\n    HookLayout,\n    create,\n    deps\n  );\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"function updateEffectImpl(fiberEffectTag, hookEffectTag, create, deps): void {\n  const hook = updateWorkInProgressHook();\n  const nextDeps = deps === undefined ? null : deps;\n  let destroy = undefined;\n\n  if (currentHook !== null) {\n    const prevEffect = currentHook.memoizedState;\n    // \u5f53currentHook\u4e0d\u4e3a\u7a7a\u65f6\uff0c\u6302\u8f7dprevEffect\u6267\u884c\u540e\u8fd4\u56de\u7684\u51fd\u6570\u5230destroy\u4e0a\n    destroy = prevEffect.destroy;\n    if (nextDeps !== null) {\n      const prevDeps = prevEffect.deps;\n\n      // \u5224\u65ad\u65b0\u8001\u4f9d\u8d56\u662f\u5426\u76f8\u540c\n      if (areHookInputsEqual(nextDeps, prevDeps)) {\n        // \u6ce8\u610f\u8fd9\u91cc\u53ea\u900f\u4f20\u4e86hookEffectTag\uff0c\u4e3a4\uff0c\u8868\u660e\u53ea\u662f\u4e00\u4e2a\u526f\u4f5c\u7528\uff0c\u4e14\u6ca1\u6709\u66f4\u65b0\n        pushEffect(hookEffectTag, create, destroy, nextDeps);\n        return;\n      }\n    }\n  }\n\n  currentlyRenderingFiber.effectTag |= fiberEffectTag;\n\n  // \u65b0\u8001\u4f9d\u8d56\u4e0d\u540c\uff0c\u89c6\u4e3a\u4e00\u4e2a\u65b0\u7684useEffects\n  // \u6b64\u65f6destroy\u4e3aundefined\n  // \u8fd9\u91cc\u4f20\u5165\u4e86HookHasEffect | hookEffectTag\uff0c\u8868\u660e\u662f\u4e00\u4e2a\u6709\u66f4\u65b0\u7684\u526f\u4f5c\u7528\n  hook.memoizedState = pushEffect(\n    HookHasEffect | hookEffectTag,\n    create,\n    destroy,\n    nextDeps,\n  );\n}\n")),(0,a.kt)("h3",{id:"4-\u6267\u884c\u9636\u6bb5"},"4. \u6267\u884c\u9636\u6bb5"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"useEffect"),"\u4e0e",(0,a.kt)("inlineCode",{parentName:"p"},"useLayoutEffect"),"\u53ea\u6709\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"fiber"),"\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"commit"),"\u9636\u6bb5\u624d\u4f1a\u6267\u884c\uff0c\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"commit"),"\u9636\u6bb5\u4f1a\u6709\u4e09\u4e2a",(0,a.kt)("inlineCode",{parentName:"p"},"do...while"),"\u5faa\u73af\uff1a"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"commitBeforeMutationEffects"),"\u6e32\u67d3",(0,a.kt)("inlineCode",{parentName:"li"},"DOM"),"\u4e4b\u524d\u6267\u884c\u7684\u526f\u4f5c\u7528"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"commitMutationEffects"),"\u6e32\u67d3",(0,a.kt)("inlineCode",{parentName:"li"},"DOM"),"\uff0c\u8fdb\u884c",(0,a.kt)("inlineCode",{parentName:"li"},"DOM"),"\u64cd\u4f5c"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"commitLayoutEffects"),"\u6e32\u67d3\u5b8c",(0,a.kt)("inlineCode",{parentName:"li"},"DOM"),"\u4e4b\u540e\u6267\u884c\u7684\u526f\u4f5c\u7528")),(0,a.kt)("h4",{id:"41-\u5f02\u6b65\u6267\u884cuseeffect"},"4.1 \u5f02\u6b65\u6267\u884cuseEffect"),(0,a.kt)("p",null,"\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"commitBeforeMutationEffects"),"\u5faa\u73af\u91cc\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"function commitBeforeMutationEffects() {\n  while (nextEffect !== null) {\n    // \u5224\u65adeffectTag\u91cc\u662f\u5426\u6709\u526f\u4f5c\u7528Passive\u7684tag\n    if ((effectTag & Passive) !== NoEffect) {\n      if (!rootDoesHavePassiveEffects) {\n        rootDoesHavePassiveEffects = true;\n        // \u5f02\u6b65\u8c03\u5ea6\u6267\u884c\u5237\u65b0flushPassiveEffects\n        scheduleCallback(NormalPriority, () => {\n          flushPassiveEffects();\n          return null;\n        });\n      }\n    }\n    nextEffect = nextEffect.nextEffect;\n  }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"flushPassiveEffects"),"\u901a\u8fc7\u8bbe\u7f6e\u4f18\u5148\u7ea7\u8c03\u5ea6\u4e86",(0,a.kt)("inlineCode",{parentName:"p"},"flushPassiveEffectsImpl"),"\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"function flushPassiveEffectsImpl() {\n  if (rootWithPendingPassiveEffects === null) {\n    return false;\n  }\n  const root = rootWithPendingPassiveEffects;\n  const expirationTime = pendingPassiveEffectsExpirationTime;\n  rootWithPendingPassiveEffects = null;\n  pendingPassiveEffectsExpirationTime = NoWork;\n\n  const prevExecutionContext = executionContext;\n  executionContext |= CommitContext;\n  const prevInteractions = pushInteractions(root);\n\n  let effect = root.current.firstEffect;\n    while (effect !== null) {\n      try {\n            // \u5faa\u73af\u6267\u884cHooks\u7684effect\n          commitPassiveHookEffects(effect);\n        } catch (error) {\n          captureCommitPhaseError(effect, error);\n        }\n      const nextNextEffect = effect.nextEffect;\n      effect.nextEffect = null;\n      effect = nextNextEffect;\n    }\n\n  executionContext = prevExecutionContext;\n\n  flushSyncCallbackQueue();\n\n  nestedPassiveUpdateCount = rootWithPendingPassiveEffects === null ? 0 : nestedPassiveUpdateCount + 1;\n\n  return true;\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"export function commitPassiveHookEffects(finishedWork: Fiber): void {\n  if ((finishedWork.effectTag & Passive) !== NoEffect) {\n    switch (finishedWork.tag) {\n      case FunctionComponent:\n      case ForwardRef:\n      case SimpleMemoComponent:\n      case Block: {\n        // \u9650\u5236\u6027destroy\uff0c\u518d\u6267\u884cmount\uff0c\u8fd9\u662f\u4e3a\u4e86\u9632\u6b62ref\u6307\u5411\u9519\u8bef\n        commitHookEffectListUnmount(HookPassive | HookHasEffect, finishedWork);\n        commitHookEffectListMount(HookPassive | HookHasEffect, finishedWork);\n        break;\n      }\n      default:\n        break;\n    }\n  }\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"// \u5faa\u73af FunctionComponent \u4e0a\u7684 effect \u94fe\uff0c\n// \u6839\u636ehooks \u4e0a\u6bcf\u4e2a effect \u4e0a\u7684 effectTag\uff0c\u6267\u884cdestroy/create \u64cd\u4f5c\uff08\u7c7b\u4f3c\u4e8e componentDidMount/componentWillUnmount\uff09\nfunction commitHookEffectListUnmount(tag: number, finishedWork: Fiber) {\n  const updateQueue: FunctionComponentUpdateQueue | null = (finishedWork.updateQueue: any);\n  let lastEffect = updateQueue !== null ? updateQueue.lastEffect : null;\n  if (lastEffect !== null) {\n    const firstEffect = lastEffect.next;\n    let effect = firstEffect;\n    do {\n      if ((effect.tag & tag) === tag) {\n        // Unmount\u6267\u884cdestroy\n        const destroy = effect.destroy;\n        effect.destroy = undefined;\n        if (destroy !== undefined) {\n          destroy();\n        }\n      }\n      effect = effect.next;\n    } while (effect !== firstEffect);\n  }\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"function commitHookEffectListMount(tag: number, finishedWork: Fiber) {\n  const updateQueue: FunctionComponentUpdateQueue | null = (finishedWork.updateQueue: any);\n  let lastEffect = updateQueue !== null ? updateQueue.lastEffect : null;\n  if (lastEffect !== null) {\n    const firstEffect = lastEffect.next;\n    let effect = firstEffect;\n    do {\n      if ((effect.tag & tag) === tag) {\n        // Mount\u6267\u884ccreate\u9636\u6bb5\n        const create = effect.create;\n        effect.destroy = create();\n      }\n      effect = effect.next;\n    } while (effect !== firstEffect);\n  }\n}\n")),(0,a.kt)("h4",{id:"42-\u540c\u6b65\u6267\u884cuselayouteffect"},"4.2 \u540c\u6b65\u6267\u884cuseLayoutEffect"),(0,a.kt)("p",null,"\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"commitMutationEffects"),"\u9636\u6bb5\u6267\u884c",(0,a.kt)("inlineCode",{parentName:"p"},"commitWork"),"\u65f6\uff0c\u8fdb\u884c",(0,a.kt)("inlineCode",{parentName:"p"},"destroy"),"\u64cd\u4f5c"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"function (current, finishedWork) {\n   switch (finishedWork.tag) {\n    case FunctionComponent:\n    case ForwardRef:\n    case MemoComponent:\n    case SimpleMemoComponent:\n    case Block: {     \n      // \u5faa\u73af FunctionComponent \u4e0a\u7684 effect \u94fe\uff0c\n      // \u6839\u636ehooks \u4e0a\u6bcf\u4e2a effect \u4e0a\u7684 effectTag\uff0c\u6267\u884cdestroy/create \u64cd\u4f5c\uff08\u7c7b\u4f3c\u4e8e componentDidMount/componentWillUnmount\uff09\n      // \u8fd9\u91cc\u6267\u884cdestroy\u64cd\u4f5c\n      // \u6ce8\u610f\u8fd9\u91cc\u53ea\u6267\u884ctag\u662fHookLayout\u7684\u526f\u4f5c\u7528\n      commitHookEffectListUnmount(HookLayout | HookHasEffect, finishedWork);\n      return;\n    }\n}\n")),(0,a.kt)("p",null,"\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"commitLayoutEffects"),"\u9636\u6bb5\u6267\u884c",(0,a.kt)("inlineCode",{parentName:"p"},"commitLifeCycles"),"\u65f6\uff0c\u8fdb\u884c",(0,a.kt)("inlineCode",{parentName:"p"},"create"),"\u64cd\u4f5c"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"function commitLifeCycles(finishedRoot, current, finishedWork) {\n  switch (finishedWork.tag) {\n    case FunctionComponent:\n    case ForwardRef:\n    case SimpleMemoComponent:\n    case Block: {\n      // \u8fd9\u91cc\u6267\u884ccreate\u64cd\u4f5c\n      // \u6ce8\u610f\u53ea\u6709tag\u662fHookLayout\u7684\u526f\u4f5c\u7528\n      commitHookEffectListMount(HookLayout | HookHasEffect, finishedWork);\n\n      if (runAllPassiveEffectDestroysBeforeCreates) {\n        schedulePassiveEffects(finishedWork);\n      }\n      return;\n    }\n}\n")),(0,a.kt)("h3",{id:"5-\u793a\u4f8b"},"5. \u793a\u4f8b"),(0,a.kt)("p",null,"\u672c\u6587\u4ee5\u4e0b\u9762\u51fd\u6570\u4e3a\u4f8b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"import React, { useEffect } from 'react';\n\nfunction App(props, context) {\n    useEffect(function first() {\n        console.log(100);\n        return function firstReturn() {\n            console.log(199);\n        }\n    });\n\n    useEffect(function second() {\n        console.log(200);\n        return function secondReturn() {\n            console.log(299);\n        }\n    });\n\n    useEffect(function third() {\n        console.log(300);\n        return function thirdReturn() {\n            console.log(399);\n        }\n    });\n\n    return 'andy';\n}\n\nexport default App;\n")),(0,a.kt)("p",null,"\u6267\u884c\u5b8c",(0,a.kt)("inlineCode",{parentName:"p"},"mount"),"\u8fc7\u7a0b\u4ee3\u7801\u540e\uff0c\u5f97\u5230\u7684\u72b6\u6001\u5982\u4e0b\uff1a"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"fiber.memoizedState"),"\uff1a"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images202310071706586.jpg",alt:"useEffect-memoizedState"})),(0,a.kt)("p",null,"\u6700\u540e\u6267\u884c\u526f\u4f5c\u7528\u7684\u65f6\u5019\u662f\u6267\u884c",(0,a.kt)("inlineCode",{parentName:"p"},"fiber.updateQueue"),"\u4e0a\u7684\u94fe\u8868\uff1a"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images202310071708144.jpg",alt:"useEffect-updateQueue"})))}p.isMDXComponent=!0}}]);