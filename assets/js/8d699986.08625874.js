"use strict";(self.webpackChunkreact_book=self.webpackChunkreact_book||[]).push([[9347],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>b});var i=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=i.createContext({}),u=function(e){var n=i.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=u(e.components);return i.createElement(l.Provider,{value:n},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},f=i.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=u(t),f=r,b=d["".concat(l,".").concat(f)]||d[f]||c[f]||a;return t?i.createElement(b,o(o({ref:n},p),{},{components:t})):i.createElement(b,o({ref:n},p))}));function b(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,o=new Array(a);o[0]=f;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s[d]="string"==typeof e?e:r,o[1]=s;for(var u=2;u<a;u++)o[u]=t[u];return i.createElement.apply(null,o)}return i.createElement.apply(null,t)}f.displayName="MDXCreateElement"},140:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>a,metadata:()=>s,toc:()=>u});var i=t(7462),r=(t(7294),t(3905));const a={sidebar_position:2,tags:["FiberRoot","Fiber","UpdateQueue"]},o=void 0,s={unversionedId:"v16/\u51c6\u5907\u5de5\u4f5c/\u5e38\u7528\u6570\u636e\u7ed3\u6784",id:"v16/\u51c6\u5907\u5de5\u4f5c/\u5e38\u7528\u6570\u636e\u7ed3\u6784",title:"\u5e38\u7528\u6570\u636e\u7ed3\u6784",description:"FiberRoot",source:"@site/docs/v16/\u51c6\u5907\u5de5\u4f5c/\u5e38\u7528\u6570\u636e\u7ed3\u6784.md",sourceDirName:"v16/\u51c6\u5907\u5de5\u4f5c",slug:"/v16/\u51c6\u5907\u5de5\u4f5c/\u5e38\u7528\u6570\u636e\u7ed3\u6784",permalink:"/react-book/docs/v16/\u51c6\u5907\u5de5\u4f5c/\u5e38\u7528\u6570\u636e\u7ed3\u6784",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/v16/\u51c6\u5907\u5de5\u4f5c/\u5e38\u7528\u6570\u636e\u7ed3\u6784.md",tags:[{label:"FiberRoot",permalink:"/react-book/docs/tags/fiber-root"},{label:"Fiber",permalink:"/react-book/docs/tags/fiber"},{label:"UpdateQueue",permalink:"/react-book/docs/tags/update-queue"}],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,tags:["FiberRoot","Fiber","UpdateQueue"]},sidebar:"v16Sidebar",previous:{title:"\u5168\u5c40\u53d8\u91cf",permalink:"/react-book/docs/v16/\u51c6\u5907\u5de5\u4f5c/\u5168\u5c40\u53d8\u91cf"},next:{title:"currentTime-expirationTime",permalink:"/react-book/docs/v16/\u51c6\u5907\u5de5\u4f5c/currentTime-expirationTime"}},l={},u=[{value:"<code>FiberRoot</code>",id:"fiberroot",level:2},{value:"<code>Fiber</code>",id:"fiber",level:2},{value:"<code>UpdateQueue</code>",id:"updatequeue",level:2}],p={toc:u},d="wrapper";function c(e){let{components:n,...t}=e;return(0,r.kt)(d,(0,i.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"fiberroot"},(0,r.kt)("inlineCode",{parentName:"h2"},"FiberRoot")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"FiberRoot"),"\u662f\u6574\u4e2a\u5e94\u7528\u7684\u6839\u8282\u70b9\uff0c\u8bb0\u5f55\u6574\u4e2a\u5e94\u7528\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u7684\u5404\u79cd\u4fe1\u606f\u3002"),(0,r.kt)("p",null,"\u4e0e\u5b83\u5e38\u76f8\u63d0\u5e76\u8bba\u7684\u662f",(0,r.kt)("inlineCode",{parentName:"p"},"RootFiber"),"\uff0c\u5b83\u4eec\u4e4b\u95f4\u7684\u5173\u7cfb\u662f\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"FiberRoot.current = RootFiber"),";"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"RootFiber.stateNode = FiberRoot"),";")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"\n/**\n * \u521b\u5efa\u4e00\u4e2aFiberRoot\n * @param {HTMLBodyElement} containerInfo \u6302\u8f7dreact\u6811\u7684\u6839DOM\n * @param {RootTag} tag \u6839\u8282\u70b9\u7684\u7c7b\u578b\uff1aLegacyRoot\uff1a0\uff0cBlockingRoot\uff1a1\uff0cConcurrentRoot\uff1a2\n * @param {boolean} hydrate \u662f\u5426\u5f3a\u5236\u6df7\u5408\uff0c\u4e00\u822c\u505aSSR\u624d\u6709\u53ef\u80fd\u4e3atrue\uff0cbrowser\u90fd\u662ffalse\n * @constructor\n */\nfunction FiberRootNode(containerInfo, tag, hydrate) {\n\n  this.tag = tag;\n\n  // \u5f53\u524d\u5e94\u7528\u5bf9\u5e94\u7684Fiber\u5bf9\u8c61\uff0c\u662fRoot Fiber\n  this.current = null;\n\n  // root\u8282\u70b9\uff0crender\u65b9\u6cd5\u63a5\u6536\u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\n  this.containerInfo = containerInfo;\n\n  // \u662f\u5426\u662fpersistent\u66f4\u65b0\uff0c\u53ea\u6709\u5728\u6301\u4e45\u66f4\u65b0\u4e2d\u624d\u4f1a\u7528\u5230\u4f60\uff0c\u4e5f\u5c31\u662f\u4e0d\u652f\u6301\u589e\u91cf\u66f4\u65b0\u7684\u5e73\u53f0\uff0creact-dom\u4e0d\u4f1a\u7528\u5230\n  this.pendingChildren = null;\n  this.pingCache = null;\n  this.finishedExpirationTime = NoWork;\n  this.finishedWork = null;\n  this.timeoutHandle = noTimeout;\n  this.context = null;\n  this.pendingContext = null;\n  this.hydrate = hydrate;\n  this.callbackNode = null;\n  this.callbackPriority = NoPriority;\n  this.firstPendingTime = NoWork;\n  this.firstSuspendedTime = NoWork;\n  this.lastSuspendedTime = NoWork;\n  this.nextKnownPendingLevel = NoWork;\n  this.lastPingedTime = NoWork;\n  this.lastExpiredTime = NoWork;\n\n  if (enableSchedulerTracing) {\n    this.interactionThreadID = unstable_getThreadID();\n    this.memoizedInteractions = new Set();\n    this.pendingInteractionMap = new Map();\n  }\n  if (enableSuspenseCallback) {\n    this.hydrationCallbacks = null;\n  }\n}\n")),(0,r.kt)("h2",{id:"fiber"},(0,r.kt)("inlineCode",{parentName:"h2"},"Fiber")),(0,r.kt)("p",null,"\u521b\u5efa\u4e00\u4e2a",(0,r.kt)("inlineCode",{parentName:"p"},"Fiber"),"\u5bf9\u8c61\uff0c\u8bb0\u5f55\u6bcf\u4e2a\u7ec4\u4ef6\u7684\u72b6\u6001\uff0c\u4e5f\u53ef\u521b\u5efa\u4e00\u4e2a",(0,r.kt)("inlineCode",{parentName:"p"},"RootFiber"),"\u5bf9\u8c61\uff0c\u53ea\u9700\u8981\u4f20\u5165\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"tag"),"\u662f",(0,r.kt)("inlineCode",{parentName:"p"},"HostRoot"),"\u5373\u53ef\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"/**\n * \u521b\u5efa\u4e00\u4e2afiber\n * @param {WorkTag} tag \u7ec4\u4ef6\u7c7b\u578b\n * @param {object} pendingProps \u65b0\u7684\u53d8\u52a8\u5e26\u6765\u7684\u65b0\u7684props\n * @param {null|string} key fiber\u552f\u4e00\u6807\u8bc6\u7b26\n * @param {TypeOfMode} mode \u6574\u4e2a\u7ec4\u4ef6\u7684\u6a21\u5f0f\n * @constructor\n */\nfunction FiberNode(\n  tag: WorkTag,\n  pendingProps: mixed,\n  key: null | string,\n  mode: TypeOfMode,\n) {\n  // Instance\n  // \u6807\u8bb0\u4e0d\u540c\u7684\u7ec4\u4ef6\u7c7b\u578b\n  this.tag = tag;\n\n  // ReactElement\u91cc\u9762\u7684key\n  this.key = key;\n\n  // ReactElement\u91cc\u9762\u7684type\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u8c03\u7528createElement\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\n  this.elementType = null;\n\n  // \u5f02\u6b65\u7ec4\u4ef6resolved\u4e4b\u540e\u8fd4\u56de\u7684\u5185\u5bb9\uff0c\u4e00\u822c\u662ffunction\u6216\u8005class\n  this.type = null;\n\n  // \u8ddf\u5f53\u524dFiber\u76f8\u5173\u7684\u672c\u5730\u72b6\u6001\uff08\u6bd4\u5982\u6d4f\u89c8\u5668\u73af\u5883\u5c31\u662fDOM\u8282\u70b9\uff09\n  this.stateNode = null;\n\n  // Fiber\n  // \u6307\u5411\u4ed6\u5728Fiber\u8282\u70b9\u6811\u4e2d\u7684parent\uff0c\u7528\u6765\u5904\u7406\u5b8c\u8fd9\u4e2a\u8282\u70b9\u4e4b\u540e\u5411\u4e0a\u8fd4\u56de\n  this.return = null;\n\n  // \u5355\u94fe\u8868\u7ed3\u6784\n  // \u6307\u5411\u81ea\u5df1\u7684\u7b2c\u4e00\u4e2a\u5b50\u8282\u70b9\n  this.child = null;\n\n  // \u6307\u5411\u81ea\u5df1\u7684\u4e0b\u4e00\u4e2a\u5144\u5f1f\u8282\u70b9\n  this.sibling = null;\n  this.index = 0;\n\n  // ref\u5c5e\u6027\n  this.ref = null;\n\n  // \u65b0\u7684\u53d8\u52a8\u5e26\u6765\u7684\u65b0\u7684props\n  this.pendingProps = pendingProps;\n\n  // \u4e0a\u4e00\u6b21\u6e32\u67d3\u5b8c\u6210\u4e4b\u540e\u7684props\n  this.memoizedProps = null;\n\n  // \u8be5Fiber\u5bf9\u5e94\u7684\u7ec4\u4ef6\u4ea7\u751f\u7684Update\u4f1a\u5b58\u653e\u5728\u8fd9\u4e2a\u961f\u5217\u91cc\u9762\n  this.updateQueue = null;\n\n  // \u4e0a\u4e00\u6b21\u6e32\u67d3\u7684\u65f6\u5019\u7684state\n  this.memoizedState = null;\n\n  this.dependencies = null;\n\n  // \u7528\u6765\u63cf\u8ff0\u5f53\u524dFiber\u548c\u4ed6\u5b50\u6811\u7684`Bitfield`\n  // \u5171\u5b58\u7684\u6a21\u5f0f\u8868\u793a\u8fd9\u4e2a\u5b50\u6811\u662f\u5426\u9ed8\u8ba4\u662f\u5f02\u6b65\u6e32\u67d3\u7684\n  // Fiber\u88ab\u521b\u5efa\u7684\u65f6\u5019\u4ed6\u4f1a\u7ee7\u627f\u7236Fiber\n  // \u5176\u4ed6\u7684\u6807\u8bc6\u4e5f\u53ef\u4ee5\u5728\u521b\u5efa\u7684\u65f6\u5019\u88ab\u8bbe\u7f6e\n  // \u4f46\u662f\u5728\u521b\u5efa\u4e4b\u540e\u4e0d\u5e94\u8be5\u518d\u88ab\u4fee\u6539\uff0c\u7279\u522b\u662f\u4ed6\u7684\u5b50Fiber\u521b\u5efa\u4e4b\u524d\n  this.mode = mode;\n\n  // Effects\n  // \u7528\u6765\u8bb0\u5f55Side Effect\n  this.effectTag = NoEffect;\n\n  // \u5355\u94fe\u8868\u7528\u6765\u5feb\u901f\u67e5\u627e\u4e0b\u4e00\u4e2aside effect\n  this.nextEffect = null;\n\n  // \u5b50\u6811\u4e2d\u7b2c\u4e00\u4e2aside effect\n  this.firstEffect = null;\n\n  // \u5b50\u6811\u4e2d\u6700\u540e\u4e00\u4e2aside effect\n  this.lastEffect = null;\n\n  // \u4ee3\u8868\u4efb\u52a1\u5728\u672a\u6765\u7684\u54ea\u4e2a\u65f6\u95f4\u70b9\u5e94\u8be5\u88ab\u5b8c\u6210\n  // \u4e0d\u5305\u62ec\u4ed6\u7684\u5b50\u6811\u4ea7\u751f\u7684\u4efb\u52a1\n  this.expirationTime = NoWork;\n\n  // \u5feb\u901f\u786e\u5b9a\u5b50\u6811\u4e2d\u662f\u5426\u6709\u4e0d\u5728\u7b49\u5f85\u7684\u53d8\u5316\n  this.childExpirationTime = NoWork;\n\n  // \u5728Fiber\u6811\u66f4\u65b0\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6bcf\u4e2aFiber\u90fd\u4f1a\u6709\u4e00\u4e2a\u8ddf\u5176\u5bf9\u5e94\u7684Fiber\n  // \u6211\u4eec\u79f0\u4ed6\u4e3a`current <==> workInProgress`\n  // \u5728\u6e32\u67d3\u5b8c\u6210\u4e4b\u540e\u4ed6\u4eec\u4f1a\u4ea4\u6362\u4f4d\u7f6e\n  this.alternate = null;\n\n  if (enableProfilerTimer) {\n    // Note: The following is done to avoid a v8 performance cliff.\n    //\n    // Initializing the fields below to smis and later updating them with\n    // double values will cause Fibers to end up having separate shapes.\n    // This behavior/bug has something to do with Object.preventExtension().\n    // Fortunately this only impacts DEV builds.\n    // Unfortunately it makes React unusably slow for some applications.\n    // To work around this, initialize the fields below with doubles.\n    //\n    // Learn more about this here:\n    // https://github.com/facebook/react/issues/14365\n    // https://bugs.chromium.org/p/v8/issues/detail?id=8538\n    this.actualDuration = Number.NaN;\n    this.actualStartTime = Number.NaN;\n    this.selfBaseDuration = Number.NaN;\n    this.treeBaseDuration = Number.NaN;\n\n    // It's okay to replace the initial doubles with smis after initialization.\n    // This won't trigger the performance cliff mentioned above,\n    // and it simplifies other profiler code (including DevTools).\n    this.actualDuration = 0;\n    this.actualStartTime = -1;\n    this.selfBaseDuration = 0;\n    this.treeBaseDuration = 0;\n  }\n\n  // This is normally DEV-only except www when it adds listeners.\n  // TODO: remove the User Timing integration in favor of Root Events.\n  if (enableUserTimingAPI) {\n    this._debugID = debugCounter++;\n    this._debugIsCurrentlyTiming = false;\n  }\n}\n")),(0,r.kt)("h2",{id:"updatequeue"},(0,r.kt)("inlineCode",{parentName:"h2"},"UpdateQueue")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"type SharedQueue<State> = {|pending: Update<State> | null|};\n\nexport type UpdateQueue<State> = {|\n  baseState: State,\n  baseQueue: Update<State> | null,\n  shared: SharedQueue<State>,\n  effects: Array<Update<State>> | null,\n|};\n\n/**\n * \u7ed9fiber\u521d\u59cb\u5316\u4e00\u4e2aupdateQueue\n * @param {Fiber} fiber \u7ec4\u4ef6\u7684fiber\n */\nexport function initializeUpdateQueue<State>(fiber: Fiber): void {\n  const queue: UpdateQueue<State> = {\n    baseState: fiber.memoizedState,\n    baseQueue: null,\n    shared: {\n      pending: null,\n    },\n    effects: null,\n  };\n  fiber.updateQueue = queue;\n}\n\nexport function createUpdate(\n  expirationTime: ExpirationTime,\n  suspenseConfig: null | SuspenseConfig,\n): Update<*> {\n  let update: Update<*> = {\n    expirationTime,\n    suspenseConfig,\n\n    tag: UpdateState,\n    payload: null,\n    callback: null,\n\n    next: (null: any),\n  };\n  update.next = update;\n  if (__DEV__) {\n    update.priority = getCurrentPriorityLevel();\n  }\n  return update;\n}\n\n/**\n * \u5c06\u521a\u624d\u521b\u5efa\u597d\u7684update\u5bf9\u8c61\u653e\u5165fiber\u7684updateQueue\u4e2d\n * @param {object} fiber fiber\u5bf9\u8c61\n * @param {object} update update\u5bf9\u8c61\n */\nexport function enqueueUpdate<State>(fiber: Fiber, update: Update<State>) {\n  const updateQueue = fiber.updateQueue;\n  if (updateQueue === null) {\n    // Only occurs if the fiber has been unmounted.\n    return;\n  }\n\n  const sharedQueue = updateQueue.shared;\n  const pending = sharedQueue.pending;\n  if (pending === null) {\n    // This is the first update. Create a circular list.\n    // \u5982\u679cpending\u4e3anull\uff0c\u66f4\u65b0\u961f\u5217\u4e3a\u7a7a\uff0cupdate\u662f\u8fd9\u4e2a\u961f\u5217\u7684\u7b2c\u4e00\u4e2aupdate\uff0c\u6240\u4ee5\u5b83\u7684next\u8981\u6307\u5411\u81ea\u5df1\n    update.next = update;\n  } else {\n    // \u6b64\u79cd\u60c5\u51b5\u76f8\u5f53\u4e8e\u628aupdate\u653e\u5165pending\u7684next\u4e2d\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u5728\u5934\u90e8\u63d2\u5165\uff0c\n    update.next = pending.next;\n    pending.next = update;\n  }\n\n  // \u5c06update\u653e\u5165pending\u4e2d\n  sharedQueue.pending = update;\n\n  if (__DEV__) {\n    if (\n      currentlyProcessingQueue === sharedQueue &&\n      !didWarnUpdateInsideUpdate\n    ) {\n      console.error(\n        'An update (setState, replaceState, or forceUpdate) was scheduled ' +\n        'from inside an update function. Update functions should be pure, ' +\n        'with zero side-effects. Consider using componentDidUpdate or a ' +\n        'callback.',\n      );\n      didWarnUpdateInsideUpdate = true;\n    }\n  }\n}\n")))}c.isMDXComponent=!0}}]);