"use strict";(self.webpackChunkreact_book=self.webpackChunkreact_book||[]).push([[9201],{3905:(e,n,r)=>{r.d(n,{Zo:()=>p,kt:()=>m});var t=r(7294);function i(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function o(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function a(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?o(Object(r),!0).forEach((function(n){i(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function l(e,n){if(null==e)return{};var r,t,i=function(e,n){if(null==e)return{};var r,t,i={},o=Object.keys(e);for(t=0;t<o.length;t++)r=o[t],n.indexOf(r)>=0||(i[r]=e[r]);return i}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)r=o[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}var s=t.createContext({}),d=function(e){var n=t.useContext(s),r=n;return e&&(r="function"==typeof e?e(n):a(a({},n),e)),r},p=function(e){var n=d(e.components);return t.createElement(s.Provider,{value:n},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},h=t.forwardRef((function(e,n){var r=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=d(r),h=i,m=c["".concat(s,".").concat(h)]||c[h]||u[h]||o;return r?t.createElement(m,a(a({ref:n},p),{},{components:r})):t.createElement(m,a({ref:n},p))}));function m(e,n){var r=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var o=r.length,a=new Array(o);a[0]=h;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[c]="string"==typeof e?e:i,a[1]=l;for(var d=2;d<o;d++)a[d]=r[d];return t.createElement.apply(null,a)}return t.createElement.apply(null,r)}h.displayName="MDXCreateElement"},9705:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>s,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var t=r(7462),i=(r(7294),r(3905));const o={sidebar_position:4},a=void 0,l={unversionedId:"v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/\u5f00\u59cb\u5904\u7406\u539f\u751fDOM",id:"v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/\u5f00\u59cb\u5904\u7406\u539f\u751fDOM",title:"\u5f00\u59cb\u5904\u7406\u539f\u751fDOM",description:"workLoopSync",source:"@site/docs/v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/\u5f00\u59cb\u5904\u7406\u539f\u751fDOM.md",sourceDirName:"v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b",slug:"/v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/\u5f00\u59cb\u5904\u7406\u539f\u751fDOM",permalink:"/react-book/docs/v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/\u5f00\u59cb\u5904\u7406\u539f\u751fDOM",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/\u5f00\u59cb\u5904\u7406\u539f\u751fDOM.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"v16Sidebar",previous:{title:"\u5f00\u59cb\u5904\u7406AppComponent",permalink:"/react-book/docs/v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/\u5f00\u59cb\u5904\u7406AppComponent"},next:{title:"setState\u540c\u6b65\u5f02\u6b65\u539f\u7406",permalink:"/react-book/docs/v16/\u6e90\u7801\u8c03\u8bd5/setState\u540c\u6b65\u5f02\u6b65\u539f\u7406"}},s={},d=[{value:"<code>workLoopSync</code>",id:"workloopsync",level:2},{value:"<code>beginWork</code>",id:"beginwork",level:2},{value:"<code>updateHostComponent</code>",id:"updatehostcomponent",level:2},{value:"<code>shouldSetTextContent</code>",id:"shouldsettextcontent",level:2},{value:"<code>reconcileChildren</code>",id:"reconcilechildren",level:2},{value:"<code>reconcileChildFibers</code>",id:"reconcilechildfibers",level:2},{value:"<code>reconcileChildrenArray</code>",id:"reconcilechildrenarray",level:2},{value:"<code>completeUnitOfWork</code>",id:"completeunitofwork",level:2},{value:"<code>completeWork</code>",id:"completework",level:2},{value:"<code>createInstance</code>",id:"createinstance",level:2},{value:"<code>appendAllChildren</code>",id:"appendallchildren",level:2}],p={toc:d},c="wrapper";function u(e){let{components:n,...r}=e;return(0,i.kt)(c,(0,t.Z)({},p,r,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"workloopsync"},(0,i.kt)("inlineCode",{parentName:"h2"},"workLoopSync")),(0,i.kt)("p",null,"\u6bcf\u5904\u7406\u5b8c\u4e00\u4e2a fiber \uff0c\u90fd\u4f1a\u518d\u4e00\u6b21\u8fdb\u5165\u8fd9\u4e2a\u5faa\u73af\u4e2d\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function workLoopSync() {\n  // Already timed out, so perform work without checking if we need to yield.\n  while (workInProgress !== null) {\n    workInProgress = performUnitOfWork(workInProgress);\n  }\n}\n")),(0,i.kt)("p",null,"\u6b64\u65f6 ",(0,i.kt)("inlineCode",{parentName:"p"},"workInProgress")," \u4e3a\u4e0a\u4e00\u6b21\u5904\u7406\u751f\u6210\u7684 fiber \u5bf9\u8c61\uff0c\u4e5f\u5c31\u662f ",(0,i.kt)("inlineCode",{parentName:"p"},"render")," \u51fd\u6570\u4e2d\u8fd4\u56de\u7684 JSX DOM \u5bf9\u8c61\u4e2d\u7684\u7b2c\u4e00\u4e2a DOM\u3002"),(0,i.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\u5728\u751f\u6210\u7b2c\u4e00\u4e2a DOM \u5bf9\u5e94\u7684 fiber \u5bf9\u8c61\u65f6\uff0c\u4e5f\u628a\u5176\u5b50 DOM \u5bf9\u8c61\u4f5c\u4e3a ",(0,i.kt)("inlineCode",{parentName:"p"},"pendingProps")," \u6302\u8f7d\u4e86\u4e0a\u53bb\u3002"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images202309191122141.png",alt:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images202309191122141.png"})),(0,i.kt)("h2",{id:"beginwork"},(0,i.kt)("inlineCode",{parentName:"h2"},"beginWork")),(0,i.kt)("p",null,"\u6839\u636e ",(0,i.kt)("inlineCode",{parentName:"p"},"fiber.tag")," \u627e\u5230\u5bf9\u5e94\u7684\u5904\u7406\u51fd\u6570\uff0c\u8fdb\u884c\u5904\u7406\u3002"),(0,i.kt)("p",null,"\u6b64\u65f6\u53c2\u6570\u5982\u4e0b\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"current"),"\uff1anull"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"workInProgress"),"\uff1a\u7236\u7ec4\u4ef6 ",(0,i.kt)("inlineCode",{parentName:"li"},"App ClassComponent")," \u8c03\u5ea6\u65f6\u65b0\u5efa\u7684 div fiber"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"renderExpirationTime"),"\uff1a1073741823")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function beginWork(current, workInProgress, renderExpirationTime) {\n  var updateExpirationTime = workInProgress.expirationTime;\n\n  workInProgress.expirationTime = NoWork;\n\n  switch (workInProgress.tag) {\n    case HostComponent:\n      return updateHostComponent(current, workInProgress, renderExpirationTime);\n  }\n}\n")),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images202309191122141.png",alt:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images202309191122141.png"})),(0,i.kt)("h2",{id:"updatehostcomponent"},(0,i.kt)("inlineCode",{parentName:"h2"},"updateHostComponent")),(0,i.kt)("p",null,"\u5904\u7406\u539f\u751fDOM\uff0c\u53ef\u4ee5\u770b\u51fa\u5bf9\u4e8e\u539f\u751f DOM \u6ca1\u6709\u4ec0\u4e48\u7279\u522b\u7684\u8ba1\u7b97\uff0c\u4e3b\u8981\u662f\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"reconcileChildren")," \u521b\u5efa\u65b0\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"fiber")," \u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function updateHostComponent(current, workInProgress, renderExpirationTime) {\n  pushHostContext(workInProgress);\n\n  if (current === null) {\n    tryToClaimNextHydratableInstance(workInProgress);\n  }\n\n  var type = workInProgress.type;\n  var nextProps = workInProgress.pendingProps;\n  var prevProps = current !== null ? current.memoizedProps : null;\n  var nextChildren = nextProps.children;\n  var isDirectTextChild = shouldSetTextContent(type, nextProps);\n\n  if (isDirectTextChild) {\n    // We special case a direct text child of a host node. This is a common\n    // case. We won't handle it as a reified child. We will instead handle\n    // this in the host environment that also has access to this prop. That\n    // avoids allocating another HostText fiber and traversing it.\n    nextChildren = null;\n  } else if (prevProps !== null && shouldSetTextContent(type, prevProps)) {\n    // If we're switching from a direct text child to a normal child, or to\n    // empty, we need to schedule the text content to be reset.\n    workInProgress.effectTag |= ContentReset;\n  }\n\n  markRef(current, workInProgress); // Check the host config to see if the children are offscreen/hidden.\n\n  if (workInProgress.mode & ConcurrentMode && renderExpirationTime !== Never && shouldDeprioritizeSubtree(type, nextProps)) {\n    {\n      markSpawnedWork(Never);\n    } // Schedule this fiber to re-render at offscreen priority. Then bailout.\n\n    workInProgress.expirationTime = workInProgress.childExpirationTime = Never;\n    return null;\n  }\n\n  reconcileChildren(current, workInProgress, nextChildren, renderExpirationTime);\n  return workInProgress.child;\n}\n")),(0,i.kt)("h2",{id:"shouldsettextcontent"},(0,i.kt)("inlineCode",{parentName:"h2"},"shouldSetTextContent")),(0,i.kt)("p",null,"\u4e3b\u8981\u7528\u6765\u5224\u65ad\u662f\u5426\u4e3a ",(0,i.kt)("inlineCode",{parentName:"p"},"option"),"\u3001",(0,i.kt)("inlineCode",{parentName:"p"},"textarea")," \u7b49\u5b50\u5143\u7d20\u53ea\u80fd\u4e3a text \u7684\u5143\u7d20"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},'function shouldSetTextContent(type, props) {\n  return (\n    type === "textarea" ||\n    type === "option" ||\n    type === "noscript" ||\n    typeof props.children === "string" ||\n    typeof props.children === "number" ||\n    (typeof props.dangerouslySetInnerHTML === "object" &&\n      props.dangerouslySetInnerHTML !== null &&\n      props.dangerouslySetInnerHTML.__html != null)\n  );\n}\n')),(0,i.kt)("h2",{id:"reconcilechildren"},(0,i.kt)("inlineCode",{parentName:"h2"},"reconcileChildren")),(0,i.kt)("p",null,"\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"mountChildFibers")," \u4e3a\u5b50\u5143\u7d20\u521b\u5efa\u5bf9\u5e94\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"fiber")," \u3002"),(0,i.kt)("p",null,"\u6b64\u65f6\u53c2\u6570\u4e2d\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"nextChildren")," \u4e3a\u5f53\u524d DOM \u5143\u7d20\u7684 children \uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images202309221320377.png",alt:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images202309221320377.png"})),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function reconcileChildren(current, workInProgress, nextChildren, renderExpirationTime) {\n  if (current === null) {\n    // If this is a fresh new component that hasn't been rendered yet, we\n    // won't update its child set by applying minimal side-effects. Instead,\n    // we will add them all to the child before it gets rendered. That means\n    // we can optimize this reconciliation pass by not tracking side-effects.\n    workInProgress.child = mountChildFibers(workInProgress, null, nextChildren, renderExpirationTime);\n  } else {\n        // other code ...\n  }\n}\n")),(0,i.kt)("h2",{id:"reconcilechildfibers"},(0,i.kt)("inlineCode",{parentName:"h2"},"reconcileChildFibers")),(0,i.kt)("p",null,"\u6b64\u65f6\u4f20\u5165\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"newChild")," \u662f\u4e2a\u6570\u7ec4\uff0c\u6240\u4ee5\u4f1a\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"reconcileChildrenArray")," \u5904\u7406\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function reconcileChildFibers(\n  returnFiber,\n  currentFirstChild,\n  newChild,\n  expirationTime\n) {\n  if (isArray$1(newChild)) {\n    return reconcileChildrenArray(\n      returnFiber,\n      currentFirstChild,\n      newChild,\n      expirationTime\n    );\n  }\n}\n")),(0,i.kt)("h2",{id:"reconcilechildrenarray"},(0,i.kt)("inlineCode",{parentName:"h2"},"reconcileChildrenArray")),(0,i.kt)("p",null,"\u5904\u7406\u6570\u7ec4\u7c7b\u578b\u5b50\u5143\u7d20"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function reconcileChildrenArray(returnFiber, currentFirstChild, newChildren, expirationTime) {\n    var resultingFirstChild = null;\n    var previousNewFiber = null;\n    var oldFiber = currentFirstChild;\n    var lastPlacedIndex = 0;\n    var newIdx = 0;\n    var nextOldFiber = null;\n\n        // oldFiber = null\uff0c\u6240\u4ee5\u4e0d\u4f1a\u8fdb\u5165\u6b64 for \u5faa\u73af\u4e2d\n    for (; oldFiber !== null && newIdx < newChildren.length; newIdx++) {\n        // other code ...\n    }\n\n        // newIdx = 0\uff0c\u4e0d\u7b49\u4e8e newChildren.length\uff0c\u6240\u4ee5\u4e5f\u4e0d\u4f1a\u8fdb\u5165\u6b64 if \u5224\u65ad\u4e2d\n    if (newIdx === newChildren.length) {\n      // other code ...\n    }\n\n        // \u6700\u7ec8\u4f1a\u8fdb\u5165\u6b64 if \u5224\u65ad\u4e2d\n    if (oldFiber === null) {\n      // If we don't have any more existing children we can choose a fast path\n      // since the rest will all be insertions.\n      for (; newIdx < newChildren.length; newIdx++) {\n                // \u9488\u5bf9\u6bcf\u4e00\u4e2a child \u521b\u5efa\u5176\u5bf9\u5e94\u7684 fiber\uff0c\n        var _newFiber = createChild(returnFiber, newChildren[newIdx], expirationTime);\n\n        if (_newFiber === null) {\n          continue;\n        }\n\n        lastPlacedIndex = placeChild(_newFiber, lastPlacedIndex, newIdx);\n\n                // \u6784\u5efa\u5144\u5f1f\u8282\u70b9\u5173\u7cfb\n        if (previousNewFiber === null) {\n          // TODO: Move out of the loop. This only happens for the first run.\n          resultingFirstChild = _newFiber;\n        } else {\n          previousNewFiber.sibling = _newFiber;\n        }\n\n        previousNewFiber = _newFiber;\n      }\n\n      return resultingFirstChild;\n    } // Add all children to a key map for quick lookups.\n\n    var existingChildren = mapRemainingChildren(returnFiber, oldFiber); // Keep scanning and use the map to restore deleted items as moves.\n\n    for (; newIdx < newChildren.length; newIdx++) {\n      var _newFiber2 = updateFromMap(existingChildren, returnFiber, newIdx, newChildren[newIdx], expirationTime);\n\n      if (_newFiber2 !== null) {\n        if (shouldTrackSideEffects) {\n          if (_newFiber2.alternate !== null) {\n            // The new fiber is a work in progress, but if there exists a\n            // current, that means that we reused the fiber. We need to delete\n            // it from the child list so that we don't add it to the deletion\n            // list.\n            existingChildren.delete(_newFiber2.key === null ? newIdx : _newFiber2.key);\n          }\n        }\n\n        lastPlacedIndex = placeChild(_newFiber2, lastPlacedIndex, newIdx);\n\n        if (previousNewFiber === null) {\n          resultingFirstChild = _newFiber2;\n        } else {\n          previousNewFiber.sibling = _newFiber2;\n        }\n\n        previousNewFiber = _newFiber2;\n      }\n    }\n\n    if (shouldTrackSideEffects) {\n      // Any existing children that weren't consumed above were deleted. We need\n      // to add them to the deletion list.\n      existingChildren.forEach(function (child) {\n        return deleteChild(returnFiber, child);\n      });\n    }\n\n    return resultingFirstChild;\n  }\n")),(0,i.kt)("h2",{id:"completeunitofwork"},(0,i.kt)("inlineCode",{parentName:"h2"},"completeUnitOfWork")),(0,i.kt)("p",null,"React \u7684 fiber \u904d\u5386\u4e3a\u6df1\u5ea6\u4f18\u5148\u904d\u5386\uff0c\u6bcf\u6b21\u8fd4\u56de\u5176 child\uff0c\u5982\u679c child \u4e0d\u5b58\u5728\u5c31\u4f1a\u8fdb\u5165 ",(0,i.kt)("inlineCode",{parentName:"p"},"completeUnitOfWork")," \u65b9\u6cd5\u4e2d\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function completeUnitOfWork(unitOfWork) {\n  // Attempt to complete the current unit of work, then move to the next\n  // sibling. If there are no more siblings, return to the parent fiber.\n  workInProgress = unitOfWork;\n\n  do {\n    // The current, flushed, state of this fiber is the alternate. Ideally\n    // nothing should rely on this, but relying on it here means that we don't\n    // need an additional field on the work in progress.\n    var current = workInProgress.alternate;\n    var returnFiber = workInProgress.return; // Check if the work completed or if something threw.\n\n    if ((workInProgress.effectTag & Incomplete) === NoEffect) {\n      setCurrentFiber(workInProgress);\n      var next = void 0;\n\n      next = completeWork(current, workInProgress, renderExpirationTime$1)\n\n      if (next !== null) {\n        // Completing this fiber spawned new work. Work on that next.\n        return next;\n      }\n    } \n\n    var siblingFiber = workInProgress.sibling;\n\n        // \u5982\u679c\u6709\u5144\u5f1f\u8282\u70b9\u4e3a\u5904\u7406\uff0c\u76f4\u63a5\u8fd4\u56de\uff0c\u8fdb\u5165 beginWork \u5904\u7406      \n    if (siblingFiber !== null) {\n      // If there is more work to do in this returnFiber, do that next.\n      return siblingFiber;\n    } // Otherwise, return to the parent\n\n    workInProgress = returnFiber;\n  } while (workInProgress !== null); // We've reached the root.\n\n    // \u6240\u6709\u7684\u8282\u70b9\u5904\u7406\u5b8c\u6210\u540e\uff0c\u4f1a\u590d\u5236\u7ed9 workInProgressRootExitStatus \u4e00\u4e2a\u6b63\u5e38\u7ed3\u675f\u7684\u72b6\u6001\n  if (workInProgressRootExitStatus === RootIncomplete) {\n    workInProgressRootExitStatus = RootCompleted;\n  }\n\n  return null;\n}\n")),(0,i.kt)("p",null,"\u4ee5\u672c\u6b21\u4ee3\u7801\u4e3a\u4f8b\uff0c\u5f53\u5904\u7406\u5230 h2 \u6807\u7b7e\u65f6\u5c31\u8bbf\u95ee\u4e0d\u5230\u5176 child \u7684\uff0c\u6240\u4ee5\u8fdb\u5165 ",(0,i.kt)("inlineCode",{parentName:"p"},"completeUnitOfWork")," \u4e2d\uff0c\u53c2\u6570 ",(0,i.kt)("inlineCode",{parentName:"p"},"unitOfWork")," \u5982\u4e0b\u6240\u793a\uff1a"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images202309221341374.png",alt:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images202309221341374.png"})),(0,i.kt)("h2",{id:"completework"},(0,i.kt)("inlineCode",{parentName:"h2"},"completeWork")),(0,i.kt)("p",null,"\u5b8c\u6210\u5bf9 fiber \u8282\u70b9\u7684\u5904\u7406\uff0c\u6bd4\u5982\u5bf9\u539f\u751f DOM \u6765\u8bf4\uff0c\u6839\u636e fiber \u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"createElement")," \u521b\u5efa\u771f\u5b9e\u7684 DOM \u8282\u70b9\uff0c\u5e76\u4e14\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"appendChild")," \u5c06\u771f\u5b9e DOM \u8282\u70b9\u4e32\u8054\u8d77\u6765\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function completeWork(current, workInProgress, renderExpirationTime) {\n  var newProps = workInProgress.pendingProps;\n\n  switch (workInProgress.tag) {\n    // \u5904\u7406\u539f\u751f DOM \u8282\u70b9\n    case HostComponent: {\n      // div.root\n      var rootContainerInstance = getRootHostContainer();\n      var type = workInProgress.type;\n\n            // \u521b\u5efa\u771f\u5b9e DOM \u8282\u70b9\n      var instance = createInstance(\n        type,\n        newProps,\n        rootContainerInstance,\n        currentHostContext,\n        workInProgress\n      );\n\n            // \u4e32\u8054\u6240\u6709\u771f\u5b9e DOM \u8282\u70b9\n      appendAllChildren(instance, workInProgress, false, false); // This needs to be set before we mount Flare event listeners\n\n            // fiber\u7684stateNode \u90fd\u4fdd\u5b58\u7684\u662f\u8be5fiber\u5bf9\u5e94\u7684\u771f\u5b9eDOM\u8282\u70b9\n      workInProgress.stateNode = instance;\n      // (eg DOM renderer supports auto-focus for certain elements).\n      // Make sure such renderers get scheduled for later work.\n\n      if (\n                // \u6302\u8f7d\u4e00\u4e9b\u5c5e\u6027\u65b9\u6cd5\uff0c\u5c24\u5176\u662f\u521d\u59cb\u5316\u4e00\u4e9bReact\u5408\u6210\u4e8b\u4ef6\n        finalizeInitialChildren(instance, type, newProps, rootContainerInstance)\n      ) {\n        markUpdate(workInProgress);\n      }\n\n      return null;\n    }\n  }\n}\n")),(0,i.kt)("p",null,"\u521b\u5efa\u7684\u771f\u5b9e\u8282\u70b9\u5982\u4e0b\u56fe\u6240\u793a\uff1a"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images202309221422254.png",alt:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images202309221422254.png"})),(0,i.kt)("h2",{id:"createinstance"},(0,i.kt)("inlineCode",{parentName:"h2"},"createInstance")),(0,i.kt)("p",null,"\u5e95\u5c42\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"document.createElement")," \u65b9\u6cd5\u521b\u5efa\u771f\u5b9eDOM\u8282\u70b9\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"function createInstance(type, props, rootContainerInstance, hostContext, internalInstanceHandle) {\n  var parentNamespace;\n  var domElement = createElement(type, props, rootContainerInstance, parentNamespace);\n  precacheFiberNode(internalInstanceHandle, domElement);\n  updateFiberProps(domElement, props);\n  return domElement;\n}\n")),(0,i.kt)("h2",{id:"appendallchildren"},(0,i.kt)("inlineCode",{parentName:"h2"},"appendAllChildren")),(0,i.kt)("p",null,"\u6302\u8f7d\u6240\u6709\u5b50\u8282\u70b9\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"appendAllChildren = function (parent, workInProgress, needsVisibilityToggle, isHidden) {\n    // We only have the top Fiber that was created but we need recurse down its\n    // children to find all the terminal nodes.\n        // \u901a\u8fc7 fiber \u627e\u5230\u5f53\u524d\u8282\u70b9\u6240\u6709\u7684\u5b50\u5143\u7d20\n    var node = workInProgress.child;\n\n    while (node !== null) {\n      if (node.tag === HostComponent || node.tag === HostText) {\n                // \u521a\u624d\u8bf4\u4e86\uff0c\u6240\u6709fiber\u8282\u70b9\u5bf9\u5e94\u7684\u771f\u5b9eDOM\u8282\u70b9\u90fd\u4fdd\u5b58\u5728\u5176 fiber.stateNode \u4e0a\n        appendInitialChild(parent, node.stateNode);\n      } else if (node.tag === HostPortal) ; else if (node.child !== null) {\n        node.child.return = node;\n        node = node.child;\n        continue;\n      }\n\n      if (node === workInProgress) {\n        return;\n      }\n\n            // while \u5faa\u73af\u627e\u5230 node \u7684\u6240\u6709\u5144\u5f1f\u8282\u70b9\uff0c\u786e\u4fdd\u6240\u6709\u7684\u5b50\u8282\u70b9\u591f\u6302\u5728 node \u4e0a\n      while (node.sibling === null) {\n        if (node.return === null || node.return === workInProgress) {\n          return;\n        }\n\n        node = node.return;\n      }\n\n      node.sibling.return = node.return;\n      node = node.sibling;\n    }\n  };\n")))}u.isMDXComponent=!0}}]);