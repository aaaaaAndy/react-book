"use strict";(self.webpackChunkreact_book=self.webpackChunkreact_book||[]).push([[7251],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>f});var o=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,o,r=function(e,n){if(null==e)return{};var t,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var c=o.createContext({}),s=function(e){var n=o.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=s(e.components);return o.createElement(c.Provider,{value:n},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},u=o.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,c=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=s(t),u=r,f=d["".concat(c,".").concat(u)]||d[u]||m[u]||a;return t?o.createElement(f,i(i({ref:n},p),{},{components:t})):o.createElement(f,i({ref:n},p))}));function f(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,i=new Array(a);i[0]=u;var l={};for(var c in n)hasOwnProperty.call(n,c)&&(l[c]=n[c]);l.originalType=e,l[d]="string"==typeof e?e:r,i[1]=l;for(var s=2;s<a;s++)i[s]=t[s];return o.createElement.apply(null,i)}return o.createElement.apply(null,t)}u.displayName="MDXCreateElement"},2980:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>m,frontMatter:()=>a,metadata:()=>l,toc:()=>s});var o=t(7462),r=(t(7294),t(3905));const a={sidebar_position:1},i=void 0,l={unversionedId:"v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/ReactDOM.render\u6267\u884c\u8fc7\u7a0b",id:"v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/ReactDOM.render\u6267\u884c\u8fc7\u7a0b",title:"ReactDOM.render\u6267\u884c\u8fc7\u7a0b",description:"DEMO",source:"@site/docs/v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/ReactDOM.render\u6267\u884c\u8fc7\u7a0b.md",sourceDirName:"v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b",slug:"/v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/",permalink:"/react-book/docs/v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/ReactDOM.render\u6267\u884c\u8fc7\u7a0b.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"v16Sidebar",previous:{title:"\u6e90\u7801\u8c03\u8bd5",permalink:"/react-book/docs/v16/\u6e90\u7801\u8c03\u8bd5/"},next:{title:"\u5f00\u59cb\u5904\u7406HostRoot",permalink:"/react-book/docs/v16/\u6e90\u7801\u8c03\u8bd5/ReactDOM.render\u6267\u884c\u8fc7\u7a0b/\u5f00\u59cb\u5904\u7406HostRoot"}},c={},s=[{value:"DEMO",id:"demo",level:2},{value:"<code>ReactDOM.render</code> \u5165\u53e3",id:"reactdomrender-\u5165\u53e3",level:2},{value:"<code>legacyRenderSubtreeIntoContainer</code>",id:"legacyrendersubtreeintocontainer",level:2},{value:"<code>createFiberRoot</code> \u521b\u5efaRoot\u3001fiber",id:"createfiberroot-\u521b\u5efarootfiber",level:2},{value:"<code>unbatchedUpdates</code> \u4e0d\u6279\u91cf\u66f4\u65b0",id:"unbatchedupdates-\u4e0d\u6279\u91cf\u66f4\u65b0",level:2},{value:"<code>updateContainer</code> \u5f00\u59cb\u66f4\u65b0",id:"updatecontainer-\u5f00\u59cb\u66f4\u65b0",level:2},{value:"<code>scheduleWork</code> \u5f00\u59cb\u8c03\u5ea6",id:"schedulework-\u5f00\u59cb\u8c03\u5ea6",level:2},{value:"<code>performSyncWorkOnRoot</code> \u540c\u6b65\u66f4\u65b0",id:"performsyncworkonroot-\u540c\u6b65\u66f4\u65b0",level:2},{value:"<code>prepareFreshStack</code>",id:"preparefreshstack",level:2},{value:"<code>workLoopSync</code> \u5faa\u73af\u5904\u7406 fiber",id:"workloopsync-\u5faa\u73af\u5904\u7406-fiber",level:2},{value:"\u5904\u7406\u4e0d\u540c\u7c7b\u578b\u7ec4\u4ef6",id:"\u5904\u7406\u4e0d\u540c\u7c7b\u578b\u7ec4\u4ef6",level:2},{value:"<code>finishSyncRender</code> \u5f00\u59cb Commit",id:"finishsyncrender-\u5f00\u59cb-commit",level:2},{value:"<code>commitRootImpl</code>",id:"commitrootimpl",level:2},{value:"<code>commitBeforeMutationEffects</code>",id:"commitbeforemutationeffects",level:2},{value:"<code>commitMutationEffects</code>",id:"commitmutationeffects",level:2},{value:"<code>commitLayoutEffects</code>",id:"commitlayouteffects",level:2},{value:"<code>commitPlacement</code>",id:"commitplacement",level:2},{value:"<code>insertOrAppendPlacementNodeIntoContainer</code>",id:"insertorappendplacementnodeintocontainer",level:2},{value:"<code>commitLifeCycles</code>",id:"commitlifecycles",level:2}],p={toc:s},d="wrapper";function m(e){let{components:n,...t}=e;return(0,r.kt)(d,(0,o.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"demo"},"DEMO"),(0,r.kt)("p",null,"\u4ee5\u4e0b\u9762 App \u8c03\u8bd5\u4e3a\u4f8b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},"import React, {Component} from 'react';\nimport ReactDOM from 'react-dom';\n\nclass App extends Component {\n  render() {\n    return (\n      <div>\n        <h2>title 2</h2>\n        <p>content p</p>\n      </div>\n    );\n  }\n}\n\nconst renderFinish = () => {\n  console.log(222, 'renderFinish');\n  \n  const container = document.getElementById('root');\n  \n  console.log(333, container, container._reactRootContainer);\n}\n\nReactDOM.render(<App />, document.getElementById('root'), renderFinish);\n")),(0,r.kt)("p",null,"\u4ee5\u8be5 Demo \u6765\u8bf4\uff0c\u5176 fiber \u6811\u5982\u4e0b\u6240\u793a\uff1a"),(0,r.kt)("mermaid",{value:"graph TD\n  A(HostRoot) --\x3e B[App]\n  B --\x3e C[div]\n  C --\x3e D[h2]\n  C --\x3e E[p]  "}),(0,r.kt)("p",null,"\u5728 render \u8fc7\u7a0b\u4e2d\u671f\u5904\u7406\u987a\u5e8f\u5982\u4e0b\uff1a"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"beginWork(HostRoot)")," \u2014> ",(0,r.kt)("inlineCode",{parentName:"p"},"beginWork(App)")," \u2014> ",(0,r.kt)("inlineCode",{parentName:"p"},"beginWork(div)")," \u2014> ",(0,r.kt)("inlineCode",{parentName:"p"},"beginWork(h2)")," \u2014> ",(0,r.kt)("inlineCode",{parentName:"p"},"completeWork(h2)")," \u2014> ",(0,r.kt)("inlineCode",{parentName:"p"},"beginWork(p)")," \u2014> ",(0,r.kt)("inlineCode",{parentName:"p"},"completeWork(p)")," \u2014> ",(0,r.kt)("inlineCode",{parentName:"p"},"completeWork(div)")," \u2014> ",(0,r.kt)("inlineCode",{parentName:"p"},"completeWork(App)")," \u2014> ",(0,r.kt)("inlineCode",{parentName:"p"},"completeWork(HostRoot)")),(0,r.kt)("h2",{id:"reactdomrender-\u5165\u53e3"},(0,r.kt)("inlineCode",{parentName:"h2"},"ReactDOM.render")," \u5165\u53e3"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// ReactDOM.render \u8c03\u7528\u7684\u65b9\u6cd5\nfunction render(element, container, callback) {\n  return legacyRenderSubtreeIntoContainer(null, element, container, false, callback);\n}\n")),(0,r.kt)("p",null,"render \u51fd\u6570\u4e2d\u7684\u53c2\u6570 element\uff0c\u4ee3\u8868 React \u7684\u9876\u5c42 DOM\n",(0,r.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images/20230904100859.png",alt:"element",title:"element"})),(0,r.kt)("p",null,"render \u51fd\u6570\u4e2d\u53c2\u6570 container\uff0c\u5373\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"document.getElementById('root')")," \u83b7\u53d6\u7684\u6302\u8f7d\u5bf9\u8c61\n",(0,r.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images/20230904101036.png",alt:"container",title:"container"})),(0,r.kt)("p",null,"render \u51fd\u6570\u4e2d\u53c2\u6570 callback\uff0c\u4ee3\u8868 render \u7ed3\u675f\u540e\u6267\u884c\u7684\u56de\u8c03\u51fd\u6570\n",(0,r.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images/20230904101146.png",alt:"callback",title:"callback"})),(0,r.kt)("h2",{id:"legacyrendersubtreeintocontainer"},(0,r.kt)("inlineCode",{parentName:"h2"},"legacyRenderSubtreeIntoContainer")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u7b2c\u4e00\u6b21\u6e32\u67d3\uff0c root \u4e0d\u5b58\u5728\uff0c\u6240\u4ee5\u9700\u8981\u8c03\u7528 ",(0,r.kt)("inlineCode",{parentName:"li"},"legacyCreateRootFromDOMContainer")," \u521b\u5efa root\u3002"),(0,r.kt)("li",{parentName:"ul"},"\u521b\u5efa\u5b8c Root \u540e\u8c03\u7528 ",(0,r.kt)("inlineCode",{parentName:"li"},"updateContainer")," \u8fdb\u5165\u8c03\u5ea6\u66f4\u65b0")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"function legacyRenderSubtreeIntoContainer(parentComponent, children, container, forceHydrate, callback) {\n  if (!root) {\n    // Initial mount \u7b2c\u4e00\u6b21\u8fdb\u5165 root \u4e0d\u5b58\u5728\uff0c\u53ea\u80fd\u5148\u521b\u5efa root\n    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(container, forceHydrate);\n    fiberRoot = root._internalRoot;\n\n    // \u5bf9 ReactDOM.render \u4f20\u5165\u7684\u56de\u8c03\u51fd\u6570\u8fdb\u884c\u4e00\u6b21\u5c01\u88c5\n    if (typeof callback === 'function') {\n      var originalCallback = callback;\n\n      callback = function () {\n        var instance = getPublicRootInstance(fiberRoot);\n        originalCallback.call(instance);\n      };\n    } // Initial mount should not be batched.\n\n    // \u4e0d\u9002\u7528\u6279\u91cf\u66f4\u65b0\uff0c\u4e5f\u5c31\u662f\u9a6c\u4e0a\u5c06\u7b2c\u4e00\u6b21\u66f4\u65b0\u7ed3\u679c\u6e32\u67d3\u51fa\u6765\n    unbatchedUpdates(function () {\n      updateContainer(children, fiberRoot, parentComponent, callback);\n    });\n  }\n}\n")),(0,r.kt)("h2",{id:"createfiberroot-\u521b\u5efarootfiber"},(0,r.kt)("inlineCode",{parentName:"h2"},"createFiberRoot")," \u521b\u5efaRoot\u3001fiber"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"legacyCreateRootFromDOMContainer")," \u7ecf\u8fc7\u5c42\u5c42\u8c03\u7528\u6700\u7ec8\u8fdb\u5165\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"createFiberRoot")," \u51fd\u6570\u5185\u90e8\n\u8be5\u51fd\u6570\u521b\u5efa\u4e86 ",(0,r.kt)("inlineCode",{parentName:"p"},"FiberRoot")," \u548c ",(0,r.kt)("inlineCode",{parentName:"p"},"RootFiber")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"function createFiberRoot(containerInfo, tag, hydrate, hydrationCallbacks) {\n  // \u521b\u5efa FiberRoot\n  var root = new FiberRootNode(containerInfo, tag, hydrate);\n\n  // \u521b\u5efa RootFiber\n  var uninitializedFiber = createHostRootFiber(tag);\n\n  // \u5c06 FiberRoot \u548c RootFiber \u5173\u8054\u8d77\u6765\n  root.current = uninitializedFiber;\n  uninitializedFiber.stateNode = root;\n\n  // \u521d\u59cb\u5316 UpdateQueue\n  initializeUpdateQueue(uninitializedFiber);\n  return root;\n}\n")),(0,r.kt)("p",null,"\u521b\u5efa\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"FiberRoot"),"\n",(0,r.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images/20230904102645.png",alt:"FiberRoot",title:"FiberRoot"})),(0,r.kt)("p",null,"\u5176\u4e2d ",(0,r.kt)("inlineCode",{parentName:"p"},"FiberRoot")," \u4e2d\u7684 tag \u4ee3\u8868 RootTag \u7684\u7c7b\u578b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript",metastring:'title="\u4e09\u79cd\u6a21\u5f0f\u5bf9\u5e94\u7684Root\u7c7b\u578b"',title:'"\u4e09\u79cd\u6a21\u5f0f\u5bf9\u5e94\u7684Root\u7c7b\u578b"'},"export type RootTag = 0 | 1 | 2;\n\nexport const LegacyRoot = 0;\nexport const BlockingRoot = 1;\nexport const ConcurrentRoot = 2;\n")),(0,r.kt)("p",null,"\u521b\u5efa\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"RootFiber"),"\n",(0,r.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images/20230904102738.png",alt:"RootFiber",title:"RootFiber"})),(0,r.kt)("p",null,"\u5176\u4e2d ",(0,r.kt)("inlineCode",{parentName:"p"},"RootFiber")," \u4e2d\u7684 tag \u4ee3\u8868\u8be5 fiber \u7684\u7c7b\u578b\uff0c\u5728\u8be5 ",(0,r.kt)("inlineCode",{parentName:"p"},"RootFiber")," \u4e2d\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"fiber.tag = 3"),"\uff0c\u4ee3\u8868\u8be5 fiber \u662f\u8be5 fiber \u6811\u7684\u6839\u8282\u70b9\uff0c\u4e00\u4e2a fiber \u6811\u53ea\u80fd\u6709\u4e00\u4e2a\u6839\u8282\u70b9\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript",metastring:'title="\u4e0d\u540c fiber \u5bf9\u5e94\u7684\u7c7b\u578b"',title:'"\u4e0d\u540c',fiber:!0,'\u5bf9\u5e94\u7684\u7c7b\u578b"':!0},"export const FunctionComponent = 0;\nexport const ClassComponent = 1;\nexport const IndeterminateComponent = 2; // Before we know whether it is function or class\nexport const HostRoot = 3; // Root of a host tree. Could be nested inside another node.\nexport const HostPortal = 4; // A subtree. Could be an entry point to a different renderer.\nexport const HostComponent = 5;\nexport const HostText = 6;\nexport const Fragment = 7;\nexport const Mode = 8;\nexport const ContextConsumer = 9;\nexport const ContextProvider = 10;\nexport const ForwardRef = 11;\nexport const Profiler = 12;\nexport const SuspenseComponent = 13;\nexport const MemoComponent = 14;\nexport const SimpleMemoComponent = 15;\nexport const LazyComponent = 16;\nexport const IncompleteClassComponent = 17;\nexport const DehydratedFragment = 18;\nexport const SuspenseListComponent = 19;\nexport const FundamentalComponent = 20;\nexport const ScopeComponent = 21;\nexport const Block = 22;\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"fiber.mode = 0"),"\uff0c\u4ee3\u8868\u8fd9\u4e2a Root \u662f legacy \u6a21\u5f0f\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript",metastring:'title="TypeOfMode"',title:'"TypeOfMode"'},"export type TypeOfMode = number;\n\nexport const NoMode = 0b0000;\nexport const StrictMode = 0b0001; // 1\nexport const BlockingMode = 0b0010; // 2\nexport const ConcurrentMode = 0b0100; // 4\nexport const ProfileMode = 0b1000; // 8\n")),(0,r.kt)("h2",{id:"unbatchedupdates-\u4e0d\u6279\u91cf\u66f4\u65b0"},(0,r.kt)("inlineCode",{parentName:"h2"},"unbatchedUpdates")," \u4e0d\u6279\u91cf\u66f4\u65b0"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"executionContext")," \u4ee3\u8868\u5f53\u671f\u6267\u884c\u4e0a\u4e0b\u6587\uff0c\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"0")," \u8bf4\u660e\u6ca1\u6709\u4efb\u52a1\u6267\u884c\uff0c\u4e0d\u540c\u7684\u4efb\u52a1\u6709\u4e0d\u540c\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"context")," \u7c7b\u578b\uff0c ",(0,r.kt)("inlineCode",{parentName:"p"},"fn(a)")," \u4ee3\u8868\u521a\u624d\u4f20\u5165\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"updateContainer(children, fiberRoot, parentComponent, callback)")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images/20230904103849.png",alt:"unbatchedUpdates",title:"unbatchedUpdates"})),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript",metastring:'title="\u51e0\u79cd Context"',title:'"\u51e0\u79cd','Context"':!0},"const NoContext = /*                    */ 0b000000; // 0\nconst BatchedContext = /*               */ 0b000001; // 1\nconst EventContext = /*                 */ 0b000010; // 2\nconst DiscreteEventContext = /*         */ 0b000100; // 4\nconst LegacyUnbatchedContext = /*       */ 0b001000; // 8\nconst RenderContext = /*                */ 0b010000; // 16\nconst CommitContext = /*                */ 0b100000; // 32\n")),(0,r.kt)("h2",{id:"updatecontainer-\u5f00\u59cb\u66f4\u65b0"},(0,r.kt)("inlineCode",{parentName:"h2"},"updateContainer")," \u5f00\u59cb\u66f4\u65b0"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u8ba1\u7b97 ",(0,r.kt)("inlineCode",{parentName:"li"},"expirationTime")),(0,r.kt)("li",{parentName:"ul"},"\u521b\u5efa ",(0,r.kt)("inlineCode",{parentName:"li"},"update"),"\uff0c\u5e76\u628a ",(0,r.kt)("inlineCode",{parentName:"li"},"update")," \u6302\u8f7d\u5230\u5bf9\u5e94\u7684 ",(0,r.kt)("inlineCode",{parentName:"li"},"updateQueue")," \u4e0a"),(0,r.kt)("li",{parentName:"ul"},"\u8c03\u7528 ",(0,r.kt)("inlineCode",{parentName:"li"},"scheduleWork")," \u5f00\u59cb\u8c03\u5ea6\u66f4\u65b0")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'function updateContainer(element, container, parentComponent, callback) {\n  var current$1 = container.current;\n\n  // \u8ba1\u7b97\u5f53\u524d\u65f6\u95f4\uff0c\u7528\u6765\u7ed9\u540e\u8fb9\u8ba1\u7b97 expirationTime \u4f7f\u7528\n  // \u4f46\u662f\u56e0\u4e3a\u662f\u7b2c\u4e00\u6b21\u6e32\u67d3\uff0c\u6240\u4ee5\u4f18\u5148\u7ea7\u6bd4\u8f83\u9ad8\uff0c\u7528\u4e0d\u4e0a\u8fd9\u91cc\u8ba1\u7b97\u7684\u5f53\u524d\u65f6\u95f4\n  var currentTime = requestCurrentTimeForUpdate();\n  var suspenseConfig = requestCurrentSuspenseConfig();\n\n  // \u56e0\u4e3a\u662f\u7b2c\u4e00\u6b21\u66f4\u65b0\uff0c\u6240\u4ee5\u76f4\u63a5\u8fd4\u56de\u6700\u9ad8\u4f18\u5148\u7ea7\u65f6\u95f4\uff0c\u5373 1073741823\n  var expirationTime = computeExpirationForFiber(currentTime, current$1, suspenseConfig);\n\n  // \u521b\u5efa\u4e00\u4e2a update\uff0c\u4e3b\u8981\u4e3a\u4e86\u653e\u5728 fiber.updateQueue \u4e0a\n  var update = createUpdate(expirationTime, suspenseConfig); \n  // Caution: React DevTools currently depends on this property\n  // being called "element".\n\n  // \u628a\u9876\u5c42 jsx \u5bf9\u8c61\u653e\u5728 update \u5bf9\u8c61\u7684 payload \u4e0a\uff0c\u4ee3\u8868\u6b64\u6b21\u66f4\u65b0\u662f\u4e00\u6b21\u4ece\u5934\u5f00\u59cb\u7684\u66f4\u65b0\n  update.payload = {\n    element: element\n  };\n\n  callback = callback === undefined ? null : callback;\n\n  // \u8fd9\u91cc\u5c31\u662f\u4e4b\u524d\u7ecf\u8fc7\u5c01\u88c5\u7684 render \u4e4b\u540e\u7684\u56de\u8c03\u51fd\u6570=\\\n  if (callback !== null) {\n    update.callback = callback;\n  }\n  \n  // \u628a update \u5bf9\u8c61\u653e\u5728 fiber.updateQueue \u4e0a\n  enqueueUpdate(current$1, update);\n\n  // \u5f00\u59cb\u8c03\u5ea6\u66f4\u65b0\u4efb\u52a1\n  scheduleWork(current$1, expirationTime);\n  return expirationTime;\n}\n')),(0,r.kt)("p",null,"\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u4e3b\u8981\u662f\u7ed9 ",(0,r.kt)("inlineCode",{parentName:"p"},"fiber.updateQueue")," \u6302\u8f7d\u4e86\u4e00\u4e2a ",(0,r.kt)("inlineCode",{parentName:"p"},"update")," \u5bf9\u8c61\uff0c\u5e76\u8ba1\u7b97\u51fa\u4e86 ",(0,r.kt)("inlineCode",{parentName:"p"},"expirationTime")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images/20230904110023.png",alt:"current$1",title:"current$1"})),(0,r.kt)("h2",{id:"schedulework-\u5f00\u59cb\u8c03\u5ea6"},(0,r.kt)("inlineCode",{parentName:"h2"},"scheduleWork")," \u5f00\u59cb\u8c03\u5ea6"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u628a\u5b50 fiber \u7684\u66f4\u65b0\u65f6\u95f4\u53cd\u6620\u5230 Root \u4e0a\uff0c\u4ee5\u4fbf\u66f4\u65b9\u4fbf\u77e5\u9053\u4e00\u4e2a fiber \u6811\u662f\u5426\u9700\u8981\u66f4\u65b0"),(0,r.kt)("li",{parentName:"ul"},"\u8c03\u7528 ",(0,r.kt)("inlineCode",{parentName:"li"},"performSyncWorkOnRoot")," \u5f00\u59cb\u66f4\u65b0")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"function scheduleUpdateOnFiber(fiber, expirationTime) {\n  // \u628a fiber.updateQueue \u91cc\u7684 expirationTime \u63d0\u5230\u5916\u5c42\n  // \u6700\u7ec8 root.firstPendingTime = fiber.expirationTime = expirationTime;\n  var root = markUpdateTimeFromFiberToRoot(fiber, expirationTime);\n\n  // \u9ed8\u8ba4\u662f\u4e00\u4e2a Normal \u7684\u4f18\u5148\u7ea7\uff0c97\n  var priorityLevel = getCurrentPriorityLevel();\n\n  // \u6b64\u65f6 expirationTime = Sync = 1073741823\uff0c\u4f1a\u8fdb\u5165\u8be5 if \u5224\u65ad\n  if (expirationTime === Sync) {\n    if ( // Check if we're inside unbatchedUpdates\uff0c\u6b64\u65f6\u672c\u6765\u5c31\u5904\u4e8e unbatchedUpdates \u4e0a\u4e0b\u6587\u4e2d\n    (executionContext & LegacyUnbatchedContext) !== NoContext && // Check if we're not already rendering\n    (executionContext & (RenderContext | CommitContext)) === NoContext) {\n      // \u5f00\u59cb\u8c03\u5ea6\u66f4\u65b0\n      performSyncWorkOnRoot(root);\n    } \n  }\n}\n\n// scheduleWork \u6700\u7ec8\u8c03\u7528 scheduleUpdateOnFiber \u65b9\u6cd5\u3002\nvar scheduleWork = scheduleUpdateOnFiber; // This is split into a separate function so we can mark a fiber with pending\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"root.firstPendingTime")," \u6302\u8f7d\u4e86\u4f18\u5148\u7ea7\u6700\u9ad8\u7684\u66f4\u65b0\u65f6\u95f4"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images/20230904111557.png",alt:"root",title:"root"})),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"fiber.expirationTime")," \u4e5f\u6302\u8f7d\u4e86\u5f53\u524d fiber \u6700\u9ad8\u4f18\u5148\u7ea7\u7684\u66f4\u65b0\u65f6\u95f4"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images/20230904111701.png",alt:"fiber",title:"fiber"})),(0,r.kt)("h2",{id:"performsyncworkonroot-\u540c\u6b65\u66f4\u65b0"},(0,r.kt)("inlineCode",{parentName:"h2"},"performSyncWorkOnRoot")," \u540c\u6b65\u66f4\u65b0"),(0,r.kt)("p",null,"\u4e3b\u8981\u5206\u4e3a\u4e24\u4e2a\u9636\u6bb5\uff0c\u4e00\u4e2a\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"render")," \u9636\u6bb5\uff0c\u4e00\u4e2a\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"commit")," \u9636\u6bb5\uff0c\u4e5f\u53ef\u4ee5\u8bf4\u8be5\u51fd\u6570\u5c31\u662f\u5f00\u59cb\u8c03\u5ea6\u66f4\u65b0\u7684\u5165\u53e3\u3002"),(0,r.kt)("p",null,"\u8be5\u51fd\u6570\u4e3b\u8981\u4f5c\u7528\u662f\u8c03\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"workLoopSync")," \u5bf9 root \u8282\u70b9\u8fdb\u884c\u5faa\u73af\u5904\u7406\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"function performSyncWorkOnRoot(root) {\n  // Check if there's expired work on this root. Otherwise, render at Sync.\n  var lastExpiredTime = root.lastExpiredTime;\n  var expirationTime = lastExpiredTime !== NoWork ? lastExpiredTime : Sync;\n\n  // \u6b64\u65f6 root \u548c expirationTime \u5b58\u5728\n  // workInProgressRoot \u548c renderExpirationTime \u90fd\u4e0d\u5b58\u5728\uff0c\u6240\u4ee5\u6761\u4ef6\u6210\u7acb\uff0c\u8fdb\u5165 if \u5224\u65ad\n  if (root !== workInProgressRoot || expirationTime !== renderExpirationTime$1) {\n    // \u51c6\u5907\u4e00\u4e2a workInProgress \u6811\uff0c\u5c06\u5f53\u524d current \u4e0a\u7684\u5c5e\u6027\u90fd\u8d4b\u503c\u7ed9 workInProgress \u6811\n    prepareFreshStack(root, expirationTime);\n  } // If we have a work-in-progress fiber, it means there's still work to do\n  // in this root.\n\n  // \u7ecf\u8fc7 prepareFreshStack \u51fd\u6570\u5904\u7406\uff0cworkInProgress \u6811\u5df2\u5b58\u5728\n  if (workInProgress !== null) {\n    var prevExecutionContext = executionContext; // 8\n\n    // RenderContext = 16\uff0c\u6240\u4ee5 executionContext = 24\n    executionContext |= RenderContext; \n\n    do {\n      try {\n        // \u5faa\u73af\u540c\u6b65\u5904\u7406\n        workLoopSync();\n        break;\n      } catch (thrownValue) {\n        handleError(root, thrownValue);\n      }\n    } while (true);\n\n    executionContext = prevExecutionContext;\n\n    // root.current \u4ee3\u8868 RootFiber\uff0c\u5b83\u5bf9\u5e94\u7684 alternate \u4ee3\u8868 RootFiber \u5bf9\u5e94\u7684 workInProgress\n    // \u5f53 render \u8fc7\u7a0b\u7ed3\u675f\u540e\u628a RootFiber \u5bf9\u5e94\u7684 workInProgress \u6302\u8f7d\u5728 root.finishedWork \u4e0a\n    root.finishedWork = root.current.alternate;\n    root.finishedExpirationTime = expirationTime;\n\n    // \u7ed3\u675f\u540c\u6b65 render \u8fc7\u7a0b\uff0c\u4e5f\u8981\u5f00\u542f commit \u8fc7\u7a0b\n    finishSyncRender(root);\n\n    ensureRootIsScheduled(root);\n  }\n\n  return null;\n}\n")),(0,r.kt)("h2",{id:"preparefreshstack"},(0,r.kt)("inlineCode",{parentName:"h2"},"prepareFreshStack")),(0,r.kt)("p",null,"\u7ed9 ",(0,r.kt)("inlineCode",{parentName:"p"},"RootFiber")," \u521d\u59cb\u5316\u4e00\u4e2a ",(0,r.kt)("inlineCode",{parentName:"p"},"workInProgress")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"function prepareFreshStack(root, expirationTime) {\n  root.finishedWork = null;\n  root.finishedExpirationTime = NoWork;\n  var timeoutHandle = root.timeoutHandle;\n\n  // workInProgressRoot \u662f\u5168\u5c40\u5bf9\u8c61\uff0c\u4fdd\u5b58\u5f53\u524d\u66f4\u65b0\u7684 root \u6811\n  workInProgressRoot = root;\n\n  // \u628a root.current \u590d\u5236\u4e00\u4efd\u7ed9 workInProgress\uff0c\u4e24\u8005\u901a\u8fc7 alertnate \u76f8\u8fde\n  workInProgress = createWorkInProgress(root.current, null);\n  renderExpirationTime$1 = expirationTime;\n  workInProgressRootExitStatus = RootIncomplete;\n  workInProgressRootFatalError = null;\n  workInProgressRootLatestProcessedExpirationTime = Sync;\n  workInProgressRootLatestSuspenseTimeout = Sync;\n  workInProgressRootCanSuspendUsingConfig = null;\n  workInProgressRootNextUnprocessedUpdateTime = NoWork;\n  workInProgressRootHasPendingPing = false;\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"current.alternate = workInProgress")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"workInProgress.alternate = current"))),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/aaaaaAndy/picture/main/images/20230904113133.png",alt:"current-workInProgress",title:"current-workInProgress"})),(0,r.kt)("h2",{id:"workloopsync-\u5faa\u73af\u5904\u7406-fiber"},(0,r.kt)("inlineCode",{parentName:"h2"},"workLoopSync")," \u5faa\u73af\u5904\u7406 fiber"),(0,r.kt)("p",null,"\u6b64\u65f6\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"workInProgress")," \u8fd8\u662f\u521a\u624d\u521d\u59cb\u5316\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"workInProgress")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"function workLoopSync() {\n  // Already timed out, so perform work without checking if we need to yield.\n  // \u5faa\u73af\u5904\u7406\u6bcf\u4e00\u4e2a fiber\n  while (workInProgress !== null) {\n    workInProgress = performUnitOfWork(workInProgress);\n  }\n}\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"workInProgress")," \u5148\u540e\u6267\u884c\u987a\u5e8f\u4e3a\uff1a",(0,r.kt)("inlineCode",{parentName:"p"},"HostRoot \u2014> App \u2014> div \u2014> h2 \u2014> p")),(0,r.kt)("h2",{id:"\u5904\u7406\u4e0d\u540c\u7c7b\u578b\u7ec4\u4ef6"},"\u5904\u7406\u4e0d\u540c\u7c7b\u578b\u7ec4\u4ef6"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"%E5%BC%80%E5%A7%8B%E5%A4%84%E7%90%86AppComponent"},"\u5f00\u59cb\u5904\u7406AppComponent")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"%E5%BC%80%E5%A7%8B%E5%A4%84%E7%90%86HostRoot"},"\u5f00\u59cb\u5904\u7406HostRoot")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"%E5%BC%80%E5%A7%8B%E5%A4%84%E7%90%86%E5%8E%9F%E7%94%9FDOM"},"\u5f00\u59cb\u5904\u7406\u539f\u751fDOM"))),(0,r.kt)("h2",{id:"finishsyncrender-\u5f00\u59cb-commit"},(0,r.kt)("inlineCode",{parentName:"h2"},"finishSyncRender")," \u5f00\u59cb Commit"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"function finishSyncRender(root) {\n  // Set this to null to indicate there's no in-progress render.\n  workInProgressRoot = null;\n  commitRoot(root);\n}\n")),(0,r.kt)("h2",{id:"commitrootimpl"},(0,r.kt)("inlineCode",{parentName:"h2"},"commitRootImpl")),(0,r.kt)("p",null,"commit \u9636\u6bb5\u4e3b\u8981\u662f\u4e09\u4e2a\u5faa\u73af\u5904\u7406\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u8c03\u7528 ",(0,r.kt)("inlineCode",{parentName:"li"},"commitBeforeMutationEffects")," \u5904\u7406 DOM \u66f4\u65b0\u524d\u7684\u64cd\u4f5c"),(0,r.kt)("li",{parentName:"ul"},"\u8c03\u7528 ",(0,r.kt)("inlineCode",{parentName:"li"},"commitMutationEffects")," \u5c06\u5b9e\u73b0 DOM \u6302\u8f7d"),(0,r.kt)("li",{parentName:"ul"},"\u8c03\u7528 ",(0,r.kt)("inlineCode",{parentName:"li"},"commitLayoutEffects")," \u5904\u7406 DOM \u66f4\u65b0\u540e\u7684\u526f\u4f5c\u7528")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"function commitRootImpl(root, renderPriorityLevel) {\n  if (firstEffect !== null) {\n    nextEffect = firstEffect;\n\n    do {\n      {\n        invokeGuardedCallback(null, commitBeforeMutationEffects, null);\n      }\n    } while (nextEffect !== null);\n\n    nextEffect = firstEffect;\n\n    do {\n      {\n        invokeGuardedCallback(null, commitMutationEffects, null, root, renderPriorityLevel);\n      }\n    } while (nextEffect !== null);\n\n    root.current = finishedWork; // The next phase is the layout phase, where we call effects that read\n    nextEffect = firstEffect;\n\n    do {\n      {\n        invokeGuardedCallback(null, commitLayoutEffects, null, root, expirationTime);\n      }\n    } while (nextEffect !== null);\n\n    nextEffect = null; // Tell Scheduler to yield at the end of the frame, so the browser has an\n\n    requestPaint();\n  }\n\n  onCommitRoot(finishedWork.stateNode, expirationTime); // Always call this before exiting `commitRoot`, to ensure that any\n\n  ensureRootIsScheduled(root);\n\n  flushSyncCallbackQueue();\n  return null;\n}\n")),(0,r.kt)("h2",{id:"commitbeforemutationeffects"},(0,r.kt)("inlineCode",{parentName:"h2"},"commitBeforeMutationEffects")),(0,r.kt)("p",null,"\u4e3b\u8981\u6267\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"getSnapshotBeforeUpdate")," \u751f\u547d\u5468\u671f\u65b9\u6cd5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"function commitBeforeMutationEffects() {\n  while (nextEffect !== null) {\n    var effectTag = nextEffect.effectTag;\n\n    if ((effectTag & Snapshot) !== NoEffect) {\n      setCurrentFiber(nextEffect);\n      recordEffect();\n      var current = nextEffect.alternate;\n      // \u4e3b\u8981\u6267\u884c getSnapshotBeforeUpdate \u751f\u547d\u5468\u671f\u65b9\u6cd5\n      commitBeforeMutationLifeCycles(current, nextEffect);\n      resetCurrentFiber();\n    }\n\n    if ((effectTag & Passive) !== NoEffect) {\n      // If there are passive effects, schedule a callback to flush at\n      // the earliest opportunity.\n      if (!rootDoesHavePassiveEffects) {\n        rootDoesHavePassiveEffects = true;\n        scheduleCallback(NormalPriority, function () {\n          flushPassiveEffects();\n          return null;\n        });\n      }\n    }\n\n    nextEffect = nextEffect.nextEffect;\n  }\n}\n")),(0,r.kt)("h2",{id:"commitmutationeffects"},(0,r.kt)("inlineCode",{parentName:"h2"},"commitMutationEffects")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'function commitMutationEffects(root, renderPriorityLevel) {\n  // TODO: Should probably move the bulk of this function to commitWork.\n  while (nextEffect !== null) {\n    var primaryEffectTag = effectTag & (Placement | Update | Deletion | Hydrating);\n\n    switch (primaryEffectTag) {\n      case Placement:\n        {\n          commitPlacement(nextEffect); // Clear the "placement" from effect tag so that we know that this is\n          // inserted, before any life-cycles like componentDidMount gets called.\n          // TODO: findDOMNode doesn\'t rely on this any more but isMounted does\n          // and isMounted is deprecated anyway so we should be able to kill this.\n\n          nextEffect.effectTag &= ~Placement;\n          break;\n        }\n    } \n\n    recordEffect();\n    resetCurrentFiber();\n    nextEffect = nextEffect.nextEffect;\n  }\n}\n')),(0,r.kt)("h2",{id:"commitlayouteffects"},(0,r.kt)("inlineCode",{parentName:"h2"},"commitLayoutEffects")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"function commitLayoutEffects(root, committedExpirationTime) {\n  // TODO: Should probably move the bulk of this function to commitWork.\n  while (nextEffect !== null) {\n    setCurrentFiber(nextEffect);\n    var effectTag = nextEffect.effectTag;\n\n    if (effectTag & (Update | Callback)) {\n      recordEffect();\n      var current = nextEffect.alternate;\n      commitLifeCycles(root, current, nextEffect);\n    }\n\n    if (effectTag & Ref) {\n      recordEffect();\n      commitAttachRef(nextEffect);\n    }\n\n    resetCurrentFiber();\n    nextEffect = nextEffect.nextEffect;\n  }\n}\n")),(0,r.kt)("h2",{id:"commitplacement"},(0,r.kt)("inlineCode",{parentName:"h2"},"commitPlacement")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"function commitPlacement(finishedWork) {\n  var parentFiber = getHostParentFiber(finishedWork); // Note: these two variables *must* always be updated together.\n\n  var parent;\n  var isContainer;\n  var parentStateNode = parentFiber.stateNode;\n\n  switch (parentFiber.tag) {\n    case HostRoot:\n      parent = parentStateNode.containerInfo;\n      isContainer = true;\n      break;\n  }\n\n  var before = getHostSibling(finishedWork); // We only have the top Fiber that was inserted but we need to recurse down its\n  // children to find all the terminal nodes.\n  // true\n  if (isContainer) {\n    // \u4f1a\u8fdb\u5165\u6b64\u5904\n    insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent);\n  } else {\n    // todo\n  }\n}\n")),(0,r.kt)("h2",{id:"insertorappendplacementnodeintocontainer"},(0,r.kt)("inlineCode",{parentName:"h2"},"insertOrAppendPlacementNodeIntoContainer")),(0,r.kt)("p",null,"\u6b64\u65f6\u53c2\u6570\u5982\u4e0b\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"node"),"\uff1a",(0,r.kt)("inlineCode",{parentName:"li"},"App ClassComponent")," \u5bf9\u5e94\u7684 ",(0,r.kt)("inlineCode",{parentName:"li"},"fiber")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"before"),"\uff1a",(0,r.kt)("inlineCode",{parentName:"li"},"null")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"parent"),"\uff1a",(0,r.kt)("inlineCode",{parentName:"li"},"div.root"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"function insertOrAppendPlacementNodeIntoContainer(node, before, parent) {\n  var tag = node.tag;\n  var isHost = tag === HostComponent || tag === HostText;\n\n  if (isHost || enableFundamentalAPI ) {\n    var stateNode = isHost ? node.stateNode : node.stateNode.instance;\n\n    if (before) {\n      // \u8c03\u7528 insertBefore \u628a stateNode \u63d2\u5165 before \u8282\u70b9\u4e4b\u524d\n      insertInContainerBefore(parent, stateNode, before);\n    } else {\n      // \u6267\u884c appendChild \u628a\u6839 DOM \u8282\u70b9\u63d2\u5165 div.root \u4e0b\n      appendChildToContainer(parent, stateNode);\n    }\n  } else if (tag === HostPortal) ; else {\n    var child = node.child;\n\n    if (child !== null) {\n      // \u9012\u5f52\u8c03\u7528\u81ea\u8eab\n      insertOrAppendPlacementNodeIntoContainer(child, before, parent);\n      var sibling = child.sibling;\n\n      // \u8be5\u5faa\u73af\u662f\u5e94\u5bf9 App \u4e0b\u8fb9\u9876\u5c42 DOM \u662f\u4e2a\u5217\u8868\u7684\u60c5\u51b5\n      // \u6240\u4ee5\u8fd9\u624d\u662f HostRoot \u5b58\u5728\u7684\u610f\u4e49\uff0c\u603b\u8981\u6709\u4e2a\u7edf\u4e00\u7684\u6536\u53e3\n      while (sibling !== null) {\n        insertOrAppendPlacementNodeIntoContainer(sibling, before, parent);\n        sibling = sibling.sibling;\n      }\n    }\n  }\n}\n")),(0,r.kt)("h2",{id:"commitlifecycles"},(0,r.kt)("inlineCode",{parentName:"h2"},"commitLifeCycles")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"function commitLifeCycles(finishedRoot, current, finishedWork, committedExpirationTime) {\n  switch (finishedWork.tag) {\n    case ClassComponent:\n      {\n        var instance = finishedWork.stateNode;\n\n        if (finishedWork.effectTag & Update) {\n          if (current === null) {\n            startPhaseTimer(finishedWork, 'componentDidMount'); // We could update instance props and state here,\n            // but instead we rely on them being set during last render.\n            // TODO: revisit this when we implement resuming.\n\n            {\n              if (finishedWork.type === finishedWork.elementType && !didWarnAboutReassigningProps) {\n                if (instance.props !== finishedWork.memoizedProps) {\n                  error('Expected %s props to match memoized props before ' + 'componentDidMount. ' + 'This might either be because of a bug in React, or because ' + 'a component reassigns its own `this.props`. ' + 'Please file an issue.', getComponentName(finishedWork.type) || 'instance');\n                }\n\n                if (instance.state !== finishedWork.memoizedState) {\n                  error('Expected %s state to match memoized state before ' + 'componentDidMount. ' + 'This might either be because of a bug in React, or because ' + 'a component reassigns its own `this.props`. ' + 'Please file an issue.', getComponentName(finishedWork.type) || 'instance');\n                }\n              }\n            }\n\n            // \u6267\u884c componentDidMount\n            instance.componentDidMount();\n            stopPhaseTimer();\n          } else {\n            var prevProps = finishedWork.elementType === finishedWork.type ? current.memoizedProps : resolveDefaultProps(finishedWork.type, current.memoizedProps);\n            var prevState = current.memoizedState;\n            startPhaseTimer(finishedWork, 'componentDidUpdate'); // We could update instance props and state here,\n            // but instead we rely on them being set during last render.\n            // TODO: revisit this when we implement resuming.\n\n            {\n              if (finishedWork.type === finishedWork.elementType && !didWarnAboutReassigningProps) {\n                if (instance.props !== finishedWork.memoizedProps) {\n                  error('Expected %s props to match memoized props before ' + 'componentDidUpdate. ' + 'This might either be because of a bug in React, or because ' + 'a component reassigns its own `this.props`. ' + 'Please file an issue.', getComponentName(finishedWork.type) || 'instance');\n                }\n\n                if (instance.state !== finishedWork.memoizedState) {\n                  error('Expected %s state to match memoized state before ' + 'componentDidUpdate. ' + 'This might either be because of a bug in React, or because ' + 'a component reassigns its own `this.props`. ' + 'Please file an issue.', getComponentName(finishedWork.type) || 'instance');\n                }\n              }\n            }\n\n            // \u6267\u884c componentDidUpdate\n            instance.componentDidUpdate(prevProps, prevState, instance.__reactInternalSnapshotBeforeUpdate);\n            stopPhaseTimer();\n          }\n        }\n\n        var updateQueue = finishedWork.updateQueue;\n\n        if (updateQueue !== null) {\n          {\n            if (finishedWork.type === finishedWork.elementType && !didWarnAboutReassigningProps) {\n              if (instance.props !== finishedWork.memoizedProps) {\n                error('Expected %s props to match memoized props before ' + 'processing the update queue. ' + 'This might either be because of a bug in React, or because ' + 'a component reassigns its own `this.props`. ' + 'Please file an issue.', getComponentName(finishedWork.type) || 'instance');\n              }\n\n              if (instance.state !== finishedWork.memoizedState) {\n                error('Expected %s state to match memoized state before ' + 'processing the update queue. ' + 'This might either be because of a bug in React, or because ' + 'a component reassigns its own `this.props`. ' + 'Please file an issue.', getComponentName(finishedWork.type) || 'instance');\n              }\n            }\n          } // We could update instance props and state here,\n          // but instead we rely on them being set during last render.\n          // TODO: revisit this when we implement resuming.\n\n\n          commitUpdateQueue(finishedWork, updateQueue, instance);\n        }\n\n        return;\n      }\n\n    case HostRoot:\n      {\n        var _updateQueue = finishedWork.updateQueue;\n\n        if (_updateQueue !== null) {\n          var _instance = null;\n\n          if (finishedWork.child !== null) {\n            switch (finishedWork.child.tag) {\n              case HostComponent:\n                _instance = getPublicInstance(finishedWork.child.stateNode);\n                break;\n\n              case ClassComponent:\n                _instance = finishedWork.child.stateNode;\n                break;\n            }\n          }\n\n          // \u6267\u884c ReactDOM.render \u7684\u56de\u8c03\u65b9\u6cd5\n          commitUpdateQueue(finishedWork, _updateQueue, _instance);\n        }\n\n        return;\n      }\n\n    case HostComponent:\n      {\n        var _instance2 = finishedWork.stateNode; // Renderers may schedule work to be done after host components are mounted\n        // (eg DOM renderer may schedule auto-focus for inputs and form controls).\n        // These effects should only be committed when components are first mounted,\n        // aka when there is no current/alternate.\n\n        if (current === null && finishedWork.effectTag & Update) {\n          var type = finishedWork.type;\n          var props = finishedWork.memoizedProps;\n          commitMount(_instance2, type, props);\n        }\n\n        return;\n      }\n}\n")))}m.isMDXComponent=!0}}]);